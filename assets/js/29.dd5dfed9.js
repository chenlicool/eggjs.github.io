(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{235:function(t,a,s){"use strict";s.r(a);var n=s(0),e=Object(n.a)({},function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"使用插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用插件","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用插件")]),t._v(" "),s("h2",{attrs:{id:"使用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用场景","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用场景")]),t._v(" "),s("p",[s("strong",[t._v("插件机制是我们框架的一大特色。它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。")])]),t._v(" "),s("p",[t._v("我们在使用 "),s("code",[t._v("Koa")]),t._v(" 中间件过程中发现了下面一些问题：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("中间件是有先后顺序的，需要统一管控")]),t._v("，但是它自身却无法管理这种顺序，只能交给使用者。这样其实非常不友好，一旦顺序不对，结果可能有天壤之别。")]),t._v(" "),s("li",[s("strong",[t._v("中间件的定位是拦截用户请求")]),t._v("，并在它前后做一些事情，例如：鉴权、安全检查、访问日志等等。但实际情况是，"),s("strong",[t._v("有些功能是和请求无关的")]),t._v("，例如：定时任务、消息订阅、后台逻辑等等。")]),t._v(" "),s("li",[t._v("一些"),s("strong",[t._v("复杂的初始化逻辑")]),t._v("，需要在应用启动的时候完成，这显然也不适合放到中间件中去实现。")])]),t._v(" "),s("p",[t._v("综上所述，我们需要一套更加强大的机制，来管理、编排那些相对独立的业务逻辑。")]),t._v(" "),s("h2",{attrs:{id:"使用插件-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用插件-2","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用插件")]),t._v(" "),s("p",[t._v("举个例子，我们想引入 "),s("a",{attrs:{href:"https://github.com/eggjs/egg-validate",target:"_blank",rel:"noopener noreferrer"}},[t._v("egg-validate"),s("OutboundLink")],1),t._v(" 这个插件。")]),t._v(" "),s("h3",{attrs:{id:"安装依赖"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖","aria-hidden":"true"}},[t._v("#")]),t._v(" 安装依赖")]),t._v(" "),s("p",[t._v("插件一般通过 "),s("code",[t._v("npm")]),t._v(" 模块的方式进行复用：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" egg-validate --save\n")])])]),s("p",[s("strong",[t._v("注意：我们建议通过 "),s("code",[t._v("^")]),t._v(" 的方式引入依赖，并且强烈不建议锁定版本。")])]),t._v(" "),s("div",{staticClass:"tip custom-block"},[s("p",{staticClass:"custom-block-title"},[t._v("友情提示")]),t._v(" "),s("p",[t._v("有些插件是内置到框架中，但默认不开启的，此时无需手动安装依赖。详见下文。")])]),t._v(" "),s("h3",{attrs:{id:"挂载插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#挂载插件","aria-hidden":"true"}},[t._v("#")]),t._v(" 挂载插件")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("config/plugin.js")]),t._v(" 中声明：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/plugin.js")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("validate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg-validate'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"使用插件-3"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用插件-3","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用插件")]),t._v(" "),s("p",[t._v("然后就可以使用插件提供的功能：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app/controller/user.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UserController")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Controller")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("create")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" rule "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'string'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("validate")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ctx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("h2",{attrs:{id:"了解插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#了解插件","aria-hidden":"true"}},[t._v("#")]),t._v(" 了解插件")]),t._v(" "),s("p",[s("strong",[t._v("一个插件其实就是一个『迷你的应用』，和应用几乎一模一样")]),t._v("。")]),t._v(" "),s("h3",{attrs:{id:"目录结构"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#目录结构","aria-hidden":"true"}},[t._v("#")]),t._v(" 目录结构")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("my-plugin\n├── app\n│   ├── "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v("\n│   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   └── user.js\n│   ├── middleware\n│   "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   └── response_time.js\n│   └── extend\n│       ├── application.js\n│       ├── context.js\n│       └── helper.js\n├── config\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   ├── config.default.js\n│   ├── config.prod.js\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   ├── config.local.js\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   └── config.unittest.js\n├── "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("test")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("   └── "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("service")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("       └── user.test.js\n└── package.json\n")])])]),s("h3",{attrs:{id:"service"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service","aria-hidden":"true"}},[t._v("#")]),t._v(" Service")]),t._v(" "),s("p",[t._v("插件可以包含 "),s("router-link",{attrs:{to:"/zh/guide/service.html"}},[t._v("Service")]),t._v("，框架会自动挂载。")],1),t._v(" "),s("h3",{attrs:{id:"config"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#config","aria-hidden":"true"}},[t._v("#")]),t._v(" Config")]),t._v(" "),s("p",[t._v("插件可以包含 "),s("router-link",{attrs:{to:"/zh/guide/config.html"}},[t._v("配置")]),t._v("。")],1),t._v(" "),s("p",[t._v("插件一般会包含自己的默认配置，应用开发者可以自由覆盖对应的配置：")]),t._v(" "),s("p",[t._v("譬如 "),s("a",{attrs:{href:"https://github.com/eggjs/egg-static",target:"_blank",rel:"noopener noreferrer"}},[t._v("egg-static"),s("OutboundLink")],1),t._v(" 插件默认的 "),s("code",[t._v("prefix")]),t._v(" 为 "),s("code",[t._v("/public/")]),t._v("。")]),t._v(" "),s("p",[t._v("你可以在应用的配置里面覆盖掉它：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/config.default.js")]),t._v("\nconfig"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("static "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  prefix"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/static/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("具体合并规则可以参见"),s("router-link",{attrs:{to:"/zh/guide/config.html"}},[t._v("配置")]),t._v("。")],1),t._v(" "),s("h3",{attrs:{id:"middleware"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#middleware","aria-hidden":"true"}},[t._v("#")]),t._v(" Middleware")]),t._v(" "),s("p",[t._v("插件可以包含 "),s("router-link",{attrs:{to:"/zh/guide/middleware.html"}},[t._v("中间件")]),t._v("。")],1),t._v(" "),s("p",[t._v("框架把插件的 "),s("code",[t._v("app/middleware")]),t._v(" 目录下的文件，同样加载到 "),s("code",[t._v("app.middleware")]),t._v(" 上。")]),t._v(" "),s("p",[t._v("大部分情况下，插件开发者会自动挂载中间件到对应的地方，无需应用开发者处理。")]),t._v(" "),s("p",[t._v("但某些情况下，插件仅提供了中间件定义，并不帮应用开发者决定挂载顺序。")]),t._v(" "),s("p",[t._v("此时，应用开发者只需遵循 "),s("router-link",{attrs:{to:"/zh/guide/middleware.html"}},[t._v("中间件")]),t._v(" 文档来使用即可。")],1),t._v(" "),s("h3",{attrs:{id:"extend"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#extend","aria-hidden":"true"}},[t._v("#")]),t._v(" Extend")]),t._v(" "),s("p",[t._v("插件可以提供 "),s("router-link",{attrs:{to:"/zh/guide/context.html#如何扩展"}},[t._v("Context")]),t._v("、"),s("router-link",{attrs:{to:"/zh/guide/application.html#如何扩展"}},[t._v("Application")]),t._v("、"),s("router-link",{attrs:{to:"/zh/guide/helper.html#如何扩展"}},[t._v("Helper")]),t._v(" 等的扩展。")],1),t._v(" "),s("p",[t._v("譬如在插件里面提供以下扩展，对应的逻辑就可以共享给其他应用。")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// {plugin_root}/app/extend/context.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UA")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Symbol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Context#ua'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" useragent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'useragent'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("get")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ua")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// this 就是 ctx 对象，在其中可以调用 ctx 上的其他方法，或访问属性")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" uaString "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user-agent'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" useragent"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("uaString"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UA")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"不支持的特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#不支持的特性","aria-hidden":"true"}},[t._v("#")]),t._v(" 不支持的特性")]),t._v(" "),s("ul",[s("li",[t._v("没有 "),s("router-link",{attrs:{to:"/zh/guide/router.html"}},[t._v("Router")]),t._v(" 和 "),s("router-link",{attrs:{to:"/zh/guide/controller.html"}},[t._v("Controller")]),t._v("。")],1),t._v(" "),s("li",[t._v("没有 "),s("code",[t._v("plugin.js")]),t._v("，只能声明跟其他插件的依赖，而"),s("strong",[t._v("不能决定")]),t._v("其他插件的开启与否。")])]),t._v(" "),s("h2",{attrs:{id:"插件配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 插件配置")]),t._v(" "),s("h3",{attrs:{id:"参数介绍"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数介绍","aria-hidden":"true"}},[t._v("#")]),t._v(" 参数介绍")]),t._v(" "),s("p",[t._v("应用开发者通过 "),s("code",[t._v("config/plugin.js")]),t._v(" 来声明插件的挂载。")]),t._v(" "),s("p",[t._v("除了上面我们使用到的 "),s("code",[t._v("enable")]),t._v(" 和 "),s("code",[t._v("package")]),t._v(" 外，其他参数如下：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("enable")]),t._v(" - 是否开启此插件，默认为 "),s("code",[t._v("true")]),t._v("。")]),t._v(" "),s("li",[s("code",[t._v("package")]),t._v(" - "),s("code",[t._v("npm")]),t._v(" 模块名称，通过 "),s("code",[t._v("npm")]),t._v(" 模块形式引入插件。")]),t._v(" "),s("li",[s("code",[t._v("path")]),t._v(" - 插件绝对路径，跟 "),s("code",[t._v("package")]),t._v(" 配置互斥。")]),t._v(" "),s("li",[s("code",[t._v("env")]),t._v(" - 数组，仅在指定运行环境才开启，会覆盖插件自身 "),s("code",[t._v("package.json")]),t._v(" 中的配置。")])]),t._v(" "),s("p",[t._v("插件本身的 "),s("code",[t._v("package.json")]),t._v(" 里面也会有一个 "),s("code",[t._v("eggPlugin")]),t._v(" 属性来声明默认的属性。")]),t._v(" "),s("h3",{attrs:{id:"开启框架内置插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启框架内置插件","aria-hidden":"true"}},[t._v("#")]),t._v(" 开启框架内置插件")]),t._v(" "),s("p",[t._v("框架一般也会内置一些插件，它们有可能默认是开启或关闭的。")]),t._v(" "),s("p",[t._v("此时，应用无需配置 "),s("code",[t._v("package")]),t._v("，直接配置 "),s("code",[t._v("enable")]),t._v(" 即可：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/plugin.js")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cors "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 也可以简写为：")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("validate "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"package-和-path"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#package-和-path","aria-hidden":"true"}},[t._v("#")]),t._v(" "),s("code",[t._v("package")]),t._v(" 和 "),s("code",[t._v("path")])]),t._v(" "),s("ul",[s("li",[s("code",[t._v("package")]),t._v("：通过 "),s("code",[t._v("npm")]),t._v(" 方式引入，也是最常见的引入方式。")]),t._v(" "),s("li",[s("code",[t._v("path")]),t._v("：通过绝对路径引入。")]),t._v(" "),s("li",[t._v("后者主要场景是：应用内部抽象了一个插件，但还没达到可以发布独立插件的阶段临时使用。")]),t._v(" "),s("li",[t._v("关于这两种方式的使用场景，可以参见"),s("router-link",{attrs:{to:"/zh/workflow/progressive.html"}},[t._v("渐进式开发")]),t._v("。")],1)]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/plugin.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" path "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'path'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mysql "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" path"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("join")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__dirname"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'../lib/plugin/egg-mysql'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"根据环境配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#根据环境配置","aria-hidden":"true"}},[t._v("#")]),t._v(" 根据环境配置")]),t._v(" "),s("p",[t._v("同时，我们还支持 "),s("code",[t._v("plugin.{env}.js")]),t._v(" 这种模式，会根据"),s("router-link",{attrs:{to:"/zh/guide/config.html#运行环境"}},[t._v("运行环境")]),t._v("加载插件配置。")],1),t._v(" "),s("p",[t._v("比如定义了一个开发环境使用的插件 "),s("code",[t._v("egg-dev")]),t._v("，只希望在本地环境加载，可以安装到 "),s("code",[t._v("devDependencies")]),t._v("。")]),t._v(" "),s("p",[t._v("譬如 "),s("a",{attrs:{href:"https://github.com/eggjs/egg-development-proxyagent",target:"_blank",rel:"noopener noreferrer"}},[t._v("egg-development-proxyagent"),s("OutboundLink")],1),t._v(" 这个插件，只会在开发环境使用。")]),t._v(" "),s("p",[t._v("则我们可以只安装到 "),s("code",[t._v("devDependencies")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("npm")]),t._v(" i egg-dev --save-dev\n")])])]),s("p",[t._v("然后在 "),s("code",[t._v("plugin.local.js")]),t._v(" 中声明：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/plugin.local.js")]),t._v("\nexports"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("proxyagent "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg-development-proxyagent'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("这样在生产环境可以 "),s("code",[t._v("npm i --production")]),t._v(" 不需要下载 "),s("code",[t._v("egg-development-proxyagent")]),t._v(" 的包了。")]),t._v(" "),s("p",[s("strong",[t._v("注意:")])]),t._v(" "),s("ul",[s("li",[t._v("不存在 "),s("code",[t._v("plugin.default.js")])]),t._v(" "),s("li",[s("strong",[t._v("只能在应用层使用，在框架层请勿使用。")])])]),t._v(" "),s("h2",{attrs:{id:"常见问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常见问题","aria-hidden":"true"}},[t._v("#")]),t._v(" 常见问题")]),t._v(" "),s("h3",{attrs:{id:"如何开发一个插件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#如何开发一个插件","aria-hidden":"true"}},[t._v("#")]),t._v(" 如何开发一个插件")]),t._v(" "),s("p",[t._v("恭喜你迈出这一步，可以回馈社区。")]),t._v(" "),s("p",[t._v("具体可以参见文档：")]),t._v(" "),s("ul",[s("li",[s("router-link",{attrs:{to:"/zh/advanced/framework/plugin.html"}},[t._v("插件开发")]),t._v("。")],1),t._v(" "),s("li",[s("router-link",{attrs:{to:"/zh/workflow/progressive.html"}},[t._v("渐进式开发")]),t._v("。")],1)]),t._v(" "),s("h3",{attrs:{id:"插件太多，每个应用都要开启怎么办？"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#插件太多，每个应用都要开启怎么办？","aria-hidden":"true"}},[t._v("#")]),t._v(" 插件太多，每个应用都要开启怎么办？")]),t._v(" "),s("p",[t._v("此时应该考虑包装为一个"),s("router-link",{attrs:{to:"/zh/advanced/framework/framework.html"}},[t._v("上层框架")]),t._v("。")],1)])},[],!1,null,null,null);a.default=e.exports}}]);