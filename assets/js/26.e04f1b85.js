(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{67:function(s,t,a){"use strict";a.r(t);var n=a(0),e=Object(n.a)({},function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用场景","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用场景")]),s._v(" "),a("p",[a("strong",[s._v("插件机制是我们框架的一大特色。它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。")])]),s._v(" "),a("p",[s._v("我们在使用 "),a("code",[s._v("Koa")]),s._v(" 中间件过程中发现了下面一些问题：")]),s._v(" "),a("ol",[a("li",[a("strong",[s._v("中间件是有先后顺序的，需要统一管控")]),s._v("，但是它自身却无法管理这种顺序，只能交给使用者。这样其实非常不友好，一旦顺序不对，结果可能有天壤之别。")]),s._v(" "),a("li",[a("strong",[s._v("中间件的定位是拦截用户请求")]),s._v("，并在它前后做一些事情，例如：鉴权、安全检查、访问日志等等。但实际情况是，"),a("strong",[s._v("有些功能是和请求无关的")]),s._v("，例如：定时任务、消息订阅、后台逻辑等等。")]),s._v(" "),a("li",[s._v("一些"),a("strong",[s._v("复杂的初始化逻辑")]),s._v("，需要在应用启动的时候完成，这显然也不适合放到中间件中去实现。")])]),s._v(" "),a("p",[s._v("综上所述，我们需要一套更加强大的机制，来管理、编排那些相对独立的业务逻辑。")]),s._v(" "),a("h2",{attrs:{id:"使用插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用插件","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用插件")]),s._v(" "),a("p",[s._v("举个例子，我们想引入 "),a("a",{attrs:{href:"https://github.com/eggjs/egg-validate",target:"_blank",rel:"noopener noreferrer"}},[s._v("egg-validate"),a("OutboundLink")],1),s._v(" 这个插件。")]),s._v(" "),a("h3",{attrs:{id:"安装依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖","aria-hidden":"true"}},[s._v("#")]),s._v(" 安装依赖")]),s._v(" "),a("p",[s._v("插件一般通过 "),a("code",[s._v("npm")]),s._v(" 模块的方式进行复用：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" egg-validate --save\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("strong",[s._v("注意：我们建议通过 "),a("code",[s._v("^")]),s._v(" 的方式引入依赖，并且强烈不建议锁定版本。")])]),s._v(" "),a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[s._v("友情提示")]),s._v(" "),a("p",[s._v("有些插件是内置到框架中，但默认不开启的，此时无需手动安装依赖。详见下文。")])]),s._v(" "),a("h3",{attrs:{id:"挂载插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#挂载插件","aria-hidden":"true"}},[s._v("#")]),s._v(" 挂载插件")]),s._v(" "),a("p",[s._v("在 "),a("code",[s._v("config/plugin.js")]),s._v(" 中声明：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// config/plugin.js")]),s._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("validate "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  enable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'egg-validate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"使用插件-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用插件-2","aria-hidden":"true"}},[s._v("#")]),s._v(" 使用插件")]),s._v(" "),a("p",[s._v("然后就可以使用插件提供的功能：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// app/controller/user.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("UserController")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Controller")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("async")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" rule "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'string'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("validate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h2",{attrs:{id:"了解插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#了解插件","aria-hidden":"true"}},[s._v("#")]),s._v(" 了解插件")]),s._v(" "),a("p",[a("strong",[s._v("一个插件其实就是一个『迷你的应用』，和应用几乎一模一样")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#目录结构","aria-hidden":"true"}},[s._v("#")]),s._v(" 目录结构")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("my-plugin\n├── app\n│   ├── "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n│   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   └── user.js\n│   ├── middleware\n│   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   └── response_time.js\n│   └── extend\n│       ├── application.js\n│       ├── context.js\n│       └── helper.js\n├── config\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   ├── config.default.js\n│   ├── config.prod.js\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   ├── config.local.js\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   └── config.unittest.js\n├── "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("   └── "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v("       └── user.test.js\n└── package.json\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"service"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service","aria-hidden":"true"}},[s._v("#")]),s._v(" Service")]),s._v(" "),a("p",[s._v("插件可以包含 "),a("router-link",{attrs:{to:"/zh/guide/service.html"}},[s._v("Service")]),s._v("，框架会自动挂载。")],1),s._v(" "),a("h3",{attrs:{id:"config"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#config","aria-hidden":"true"}},[s._v("#")]),s._v(" Config")]),s._v(" "),a("p",[s._v("插件可以包含 "),a("router-link",{attrs:{to:"/zh/guide/config.html"}},[s._v("配置")]),s._v("。")],1),s._v(" "),a("p",[s._v("插件一般会包含自己的默认配置，应用开发者可以自由覆盖对应的配置：")]),s._v(" "),a("p",[s._v("譬如 "),a("a",{attrs:{href:"https://github.com/eggjs/egg-static",target:"_blank",rel:"noopener noreferrer"}},[s._v("egg-static"),a("OutboundLink")],1),s._v(" 插件默认的 "),a("code",[s._v("prefix")]),s._v(" 为 "),a("code",[s._v("/public/")]),s._v("。")]),s._v(" "),a("p",[s._v("你可以在应用的配置里面覆盖掉它：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// config/config.default.js")]),s._v("\nconfig"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("static "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  prefix"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/static/'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("具体合并规则可以参见"),a("router-link",{attrs:{to:"/zh/guide/config.html"}},[s._v("配置")]),s._v("。")],1),s._v(" "),a("h3",{attrs:{id:"middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#middleware","aria-hidden":"true"}},[s._v("#")]),s._v(" Middleware")]),s._v(" "),a("p",[s._v("插件可以包含 "),a("router-link",{attrs:{to:"/zh/guide/middleware.html"}},[s._v("中间件")]),s._v("。")],1),s._v(" "),a("p",[s._v("框架把插件的 "),a("code",[s._v("app/middleware")]),s._v(" 目录下的文件，同样加载到 "),a("code",[s._v("app.middleware")]),s._v(" 上。")]),s._v(" "),a("p",[s._v("大部分情况下，插件开发者会自动挂载中间件到对应的地方，无需应用开发者处理。")]),s._v(" "),a("p",[s._v("但某些情况下，插件仅提供了中间件定义，并不帮应用开发者决定挂载顺序。")]),s._v(" "),a("p",[s._v("此时，应用开发者只需遵循 "),a("router-link",{attrs:{to:"/zh/guide/middleware.html"}},[s._v("中间件")]),s._v(" 文档来使用即可。")],1),s._v(" "),a("h3",{attrs:{id:"extend"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#extend","aria-hidden":"true"}},[s._v("#")]),s._v(" Extend")]),s._v(" "),a("p",[s._v("插件可以提供 "),a("router-link",{attrs:{to:"/zh/guide/context.html#如何扩展"}},[s._v("Context")]),s._v("、"),a("router-link",{attrs:{to:"/zh/guide/application.html#如何扩展"}},[s._v("Application")]),s._v("、"),a("router-link",{attrs:{to:"/zh/guide/helper.html#如何扩展"}},[s._v("Helper")]),s._v(" 等的扩展。")],1),s._v(" "),a("p",[s._v("譬如在插件里面提供以下扩展，对应的逻辑就可以共享给其他应用。")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// {plugin_root}/app/extend/context.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UA")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Symbol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Context#ua'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" useragent "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'useragent'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("get")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ua")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// this 就是 ctx 对象，在其中可以调用 ctx 上的其他方法，或访问属性")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" uaString "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'user-agent'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" useragent"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("parse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uaString"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("UA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("h3",{attrs:{id:"不支持的特性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不支持的特性","aria-hidden":"true"}},[s._v("#")]),s._v(" 不支持的特性")]),s._v(" "),a("ul",[a("li",[s._v("没有 "),a("router-link",{attrs:{to:"/zh/guide/router.html"}},[s._v("Router")]),s._v(" 和 "),a("router-link",{attrs:{to:"/zh/guide/controller.html"}},[s._v("Controller")]),s._v("。")],1),s._v(" "),a("li",[s._v("没有 "),a("code",[s._v("plugin.js")]),s._v("，只能声明跟其他插件的依赖，而"),a("strong",[s._v("不能决定")]),s._v("其他插件的开启与否。")])]),s._v(" "),a("h2",{attrs:{id:"插件配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插件配置","aria-hidden":"true"}},[s._v("#")]),s._v(" 插件配置")]),s._v(" "),a("h3",{attrs:{id:"参数介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数介绍","aria-hidden":"true"}},[s._v("#")]),s._v(" 参数介绍")]),s._v(" "),a("p",[s._v("应用开发者通过 "),a("code",[s._v("config/plugin.js")]),s._v(" 来声明插件的挂载。")]),s._v(" "),a("p",[s._v("除了上面我们使用到的 "),a("code",[s._v("enable")]),s._v(" 和 "),a("code",[s._v("package")]),s._v(" 外，其他参数如下：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("enable")]),s._v(" - 是否开启此插件，默认为 "),a("code",[s._v("true")]),s._v("。")]),s._v(" "),a("li",[a("code",[s._v("package")]),s._v(" - "),a("code",[s._v("npm")]),s._v(" 模块名称，通过 "),a("code",[s._v("npm")]),s._v(" 模块形式引入插件。")]),s._v(" "),a("li",[a("code",[s._v("path")]),s._v(" - 插件绝对路径，跟 "),a("code",[s._v("package")]),s._v(" 配置互斥。")]),s._v(" "),a("li",[a("code",[s._v("env")]),s._v(" - 数组，仅在指定运行环境才开启，会覆盖插件自身 "),a("code",[s._v("package.json")]),s._v(" 中的配置。")])]),s._v(" "),a("p",[s._v("插件本身的 "),a("code",[s._v("package.json")]),s._v(" 里面也会有一个 "),a("code",[s._v("eggPlugin")]),s._v(" 属性来声明默认的属性。")]),s._v(" "),a("h3",{attrs:{id:"开启框架内置插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#开启框架内置插件","aria-hidden":"true"}},[s._v("#")]),s._v(" 开启框架内置插件")]),s._v(" "),a("p",[s._v("框架一般也会内置一些插件，它们有可能默认是开启或关闭的。")]),s._v(" "),a("p",[s._v("此时，应用无需配置 "),a("code",[s._v("package")]),s._v("，直接配置 "),a("code",[s._v("enable")]),s._v(" 即可：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// config/plugin.js")]),s._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("cors "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  enable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 也可以简写为：")]),s._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("validate "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"package-和-path"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#package-和-path","aria-hidden":"true"}},[s._v("#")]),s._v(" "),a("code",[s._v("package")]),s._v(" 和 "),a("code",[s._v("path")])]),s._v(" "),a("ul",[a("li",[a("code",[s._v("package")]),s._v("：通过 "),a("code",[s._v("npm")]),s._v(" 方式引入，也是最常见的引入方式。")]),s._v(" "),a("li",[a("code",[s._v("path")]),s._v("：通过绝对路径引入。")]),s._v(" "),a("li",[s._v("后者主要场景是：应用内部抽象了一个插件，但还没达到可以发布独立插件的阶段临时使用。")]),s._v(" "),a("li",[s._v("关于这两种方式的使用场景，可以参见"),a("router-link",{attrs:{to:"/zh/workflow/progressive.html"}},[s._v("渐进式开发")]),s._v("。")],1)]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// config/plugin.js")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" path "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'path'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("mysql "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  enable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" path"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("__dirname"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'../lib/plugin/egg-mysql'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"根据环境配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#根据环境配置","aria-hidden":"true"}},[s._v("#")]),s._v(" 根据环境配置")]),s._v(" "),a("p",[s._v("同时，我们还支持 "),a("code",[s._v("plugin.{env}.js")]),s._v(" 这种模式，会根据"),a("router-link",{attrs:{to:"/zh/guide/config.html#运行环境"}},[s._v("运行环境")]),s._v("加载插件配置。")],1),s._v(" "),a("p",[s._v("比如定义了一个开发环境使用的插件 "),a("code",[s._v("egg-dev")]),s._v("，只希望在本地环境加载，可以安装到 "),a("code",[s._v("devDependencies")]),s._v("。")]),s._v(" "),a("p",[s._v("譬如 "),a("a",{attrs:{href:"https://github.com/eggjs/egg-development-proxyagent",target:"_blank",rel:"noopener noreferrer"}},[s._v("egg-development-proxyagent"),a("OutboundLink")],1),s._v(" 这个插件，只会在开发环境使用。")]),s._v(" "),a("p",[s._v("则我们可以只安装到 "),a("code",[s._v("devDependencies")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("$ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" i egg-dev --save-dev\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("然后在 "),a("code",[s._v("plugin.local.js")]),s._v(" 中声明：")]),s._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// config/plugin.local.js")]),s._v("\nexports"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("proxyagent "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  enable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("package")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'egg-development-proxyagent'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("这样在生产环境可以 "),a("code",[s._v("npm i --production")]),s._v(" 不需要下载 "),a("code",[s._v("egg-development-proxyagent")]),s._v(" 的包了。")]),s._v(" "),a("p",[a("strong",[s._v("注意:")])]),s._v(" "),a("ul",[a("li",[s._v("不存在 "),a("code",[s._v("plugin.default.js")])]),s._v(" "),a("li",[a("strong",[s._v("只能在应用层使用，在框架层请勿使用。")])])]),s._v(" "),a("h2",{attrs:{id:"常见问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见问题","aria-hidden":"true"}},[s._v("#")]),s._v(" 常见问题")]),s._v(" "),a("h3",{attrs:{id:"如何开发一个插件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#如何开发一个插件","aria-hidden":"true"}},[s._v("#")]),s._v(" 如何开发一个插件")]),s._v(" "),a("p",[s._v("恭喜你迈出这一步，可以回馈社区。")]),s._v(" "),a("p",[s._v("具体可以参见文档：")]),s._v(" "),a("ul",[a("li",[a("router-link",{attrs:{to:"/zh/advanced/framework/plugin.html"}},[s._v("插件开发")]),s._v("。")],1),s._v(" "),a("li",[a("router-link",{attrs:{to:"/zh/workflow/progressive.html"}},[s._v("渐进式开发")]),s._v("。")],1)]),s._v(" "),a("h3",{attrs:{id:"插件太多，每个应用都要开启怎么办？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#插件太多，每个应用都要开启怎么办？","aria-hidden":"true"}},[s._v("#")]),s._v(" 插件太多，每个应用都要开启怎么办？")]),s._v(" "),a("p",[s._v("此时应该考虑包装为一个"),a("router-link",{attrs:{to:"/zh/advanced/framework/framework.html"}},[s._v("上层框架")]),s._v("。")],1)])},[],!1,null,null,null);t.default=e.exports}}]);