(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{220:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookie","aria-hidden":"true"}},[t._v("#")]),t._v(" Cookie")]),t._v(" "),a("h2",{attrs:{id:"使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用场景","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用场景")]),t._v(" "),a("p",[t._v("HTTP 请求都是无状态的，但是我们的 Web 应用通常都需要知道发起请求的人是谁。")]),t._v(" "),a("p",[t._v("为了解决这个问题，HTTP 协议设计了一个特殊的请求头："),a("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies",target:"_blank",rel:"noopener noreferrer"}},[t._v("Cookie"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("服务端可以通过响应头将少量数据响应给客户端，浏览器会遵循协议将数据保存，并在下次请求同一个服务的时候带上对应的数据。")]),t._v(" "),a("p",[a("code",[t._v("Cookie")]),t._v(" 主要用于：")]),t._v(" "),a("ul",[a("li",[t._v("会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）")]),t._v(" "),a("li",[t._v("个性化设置（如用户自定义设置、主题等）")]),t._v(" "),a("li",[t._v("浏览器行为跟踪（如跟踪分析用户行为等）")])]),t._v(" "),a("p",[t._v("服务器使用 "),a("code",[t._v("Set-Cookie")]),t._v(" 响应头部向用户浏览器发送 "),a("code",[t._v("Cookie")]),t._v(" 信息：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("HTTP/1.0 200 OK\nContent-type: text/html\nSet-Cookie: uid=123456\nSet-Cookie: user=tz\n")])])]),a("p",[t._v("后续对该服务发起的每一次新请求，浏览器都会将之前保存的信息通过 "),a("code",[t._v("Cookie")]),t._v(" 请求头回传：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("GET /user HTTP/1.1\nHost: www.example.org\nCookie: uid=123456; user=tz\n")])])]),a("h2",{attrs:{id:"使用-cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用-cookie","aria-hidden":"true"}},[t._v("#")]),t._v(" 使用 Cookie")]),t._v(" "),a("p",[t._v("框架内置了 "),a("a",{attrs:{href:"https://github.com/eggjs/egg-cookies",target:"_blank",rel:"noopener noreferrer"}},[t._v("egg-cookies"),a("OutboundLink")],1),t._v(" 插件，提供了 "),a("code",[t._v("ctx.cookies")]),t._v("，用于便捷、安全的读写 "),a("code",[t._v("Cookie")]),t._v("。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// app/controller/home.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HomeController")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Controller")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ctx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" count "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Number")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v("count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" count"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("async")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("remove")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" ctx "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("status "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("204")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[t._v("友情提示")]),t._v(" "),a("p",[t._v("在使用 "),a("code",[t._v("Cookie")]),t._v(" 时我们需要思考清楚它的场景：")]),t._v(" "),a("ul",[a("li",[t._v("需要被浏览器保存多久？")]),t._v(" "),a("li",[t._v("是否可以被 js 获取到？")]),t._v(" "),a("li",[t._v("是否可以被前端修改？")])])]),t._v(" "),a("p",[a("strong",[t._v("框架默认配置下， "),a("code",[t._v("Cookie")]),t._v(" 是加签不加密的，浏览器可以看到明文，js 不能访问，不能被客户端（手工）篡改。")])]),t._v(" "),a("h2",{attrs:{id:"术语解释"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#术语解释","aria-hidden":"true"}},[t._v("#")]),t._v(" 术语解释")]),t._v(" "),a("h3",{attrs:{id:"过期时间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#过期时间","aria-hidden":"true"}},[t._v("#")]),t._v(" 过期时间")]),t._v(" "),a("p",[a("code",[t._v("Expires")]),t._v(" 和 "),a("code",[t._v("Max-Age")]),t._v(" 用于定义 "),a("code",[t._v("Cookie")]),t._v(" 对应的键值对的持久化时间。")]),t._v(" "),a("p",[a("code",[t._v("Expires")]),t._v(" 优先级低于 "),a("code",[t._v("Max-Age")]),t._v("，如果两者都没设置，则将会在关闭浏览器时失效。")]),t._v(" "),a("h3",{attrs:{id:"作用域"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#作用域","aria-hidden":"true"}},[t._v("#")]),t._v(" 作用域")]),t._v(" "),a("p",[a("code",[t._v("Domain")]),t._v(" 和 "),a("code",[t._v("Path")]),t._v(" 标识定义了 "),a("code",[t._v("Cookie")]),t._v(" 的作用域：即 "),a("code",[t._v("Cookie")]),t._v(" 应该发送给哪些 URL。")]),t._v(" "),a("h3",{attrs:{id:"安全"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安全","aria-hidden":"true"}},[t._v("#")]),t._v(" 安全")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("Secure")]),t._v("："),a("code",[t._v("Cookie")]),t._v(" 只有在 "),a("code",[t._v("HTTPS")]),t._v(" 协议下才会发送给服务端。")]),t._v(" "),a("li",[a("code",[t._v("HttpOnly")]),t._v("："),a("code",[t._v("Cookie")]),t._v(" 将无法被 JavaScript 访问，从而避免 "),a("router-link",{attrs:{to:"/zh/ecosystem/security/xss.html"}},[t._v("XSS")]),t._v(" 攻击。")],1)]),t._v(" "),a("h3",{attrs:{id:"加签-加密"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#加签-加密","aria-hidden":"true"}},[t._v("#")]),t._v(" 加签 && 加密")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("加签")]),t._v("：对 "),a("code",[t._v("Cookie")]),t._v(" 进行签名，避免前端篡改。不会修改原键值，而是新增一个 "),a("code",[t._v("${key}.sig")]),t._v(" 的键值。")]),t._v(" "),a("li",[a("code",[t._v("加密")]),t._v("：对 "),a("code",[t._v("Cookie")]),t._v(" 进行加密，避免 "),a("code",[t._v("Cookie")]),t._v(" 明文写入，泄露给恶意用户。")])]),t._v(" "),a("h2",{attrs:{id:"api-说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#api-说明","aria-hidden":"true"}},[t._v("#")]),t._v(" API 说明")]),t._v(" "),a("h3",{attrs:{id:"set-key-value-options"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#set-key-value-options","aria-hidden":"true"}},[t._v("#")]),t._v(" "),a("code",[t._v("set(key, value, options)")])]),t._v(" "),a("p",[t._v("框架提供了 "),a("code",[t._v("ctx.set(key, value, options)")]),t._v(" 来向用户发送 "),a("code",[t._v("Cookie")]),t._v(" 信息。")]),t._v(" "),a("p",[t._v("其中，"),a("code",[t._v("key")]),t._v(" 和 "),a("code",[t._v("value")]),t._v(" 称之为一个 "),a("code",[t._v("键值对")]),t._v("。配置参数 "),a("code",[t._v("options")]),t._v(" 见"),a("a",{attrs:{href:"#options"}},[t._v("下文")]),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"get-key-options"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#get-key-options","aria-hidden":"true"}},[t._v("#")]),t._v(" "),a("code",[t._v("get(key, options)")])]),t._v(" "),a("p",[a("code",[t._v("Cookie")]),t._v(" 是通过同一个 "),a("code",[t._v("Header")]),t._v(" 中传输过来的，因此需要通过该方法解析并获取对应的值。")]),t._v(" "),a("p",[t._v("值得注意的是，获取时的 "),a("code",[t._v("options.signed")]),t._v(" 和 "),a("code",[t._v("options.encrypt")]),t._v(" 要和 "),a("code",[t._v("set()")]),t._v(" 的时候保持一致。")]),t._v(" "),a("h3",{attrs:{id:"options"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#options","aria-hidden":"true"}},[t._v("#")]),t._v(" options")]),t._v(" "),a("p",[t._v("与 "),a("a",{attrs:{href:"#%E6%9C%AF%E8%AF%AD%E8%A7%A3%E9%87%8A"}},[t._v("术语")]),t._v(" 一一对应，支持以下参数配置：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("maxAge")]),t._v(":  "),a("code",[t._v("{Number}")]),t._v(" 在浏览器的最长保存时间。")]),t._v(" "),a("li",[a("strong",[t._v("expires")]),t._v(": "),a("code",[t._v("{Date}")]),t._v(" 失效时间。优先级低于 "),a("code",[t._v("maxAge")]),t._v("。如果两者都没设置，则将会在关闭浏览器时失效。")]),t._v(" "),a("li",[a("strong",[t._v("path")]),t._v(": "),a("code",[t._v("{String}")]),t._v(" 生效的 URL 路径，默认为 "),a("code",[t._v("/")]),t._v("，即当前域名下均可访问这个 Cookie。")]),t._v(" "),a("li",[a("strong",[t._v("domain")]),t._v(": "),a("code",[t._v("{String}")]),t._v(" 对生效的域名，默认没有配置，可以配置成只在指定域名才能访问。")]),t._v(" "),a("li",[a("strong",[t._v("httpOnly")]),t._v(": "),a("code",[t._v("{Boolean}")]),t._v(" 是否可以被 js 访问，"),a("strong",[t._v("默认为 true，不允许被 js 访问")]),t._v("。")]),t._v(" "),a("li",[a("strong",[t._v("secure")]),t._v(": "),a("code",[t._v("{Boolean}")]),t._v(" 框架会自动判断当前请求是否为 HTTPS，从而自动赋值。")]),t._v(" "),a("li",[a("strong",[t._v("signed")]),t._v(": "),a("code",[t._v("{Boolean}")]),t._v("：是否加签，默认为 true。")]),t._v(" "),a("li",[a("strong",[t._v("encrypt")]),t._v(": "),a("code",[t._v("{Boolean}")]),t._v(" 是否加密，默认为 false。")])]),t._v(" "),a("p",[t._v("此外，还扩展了：")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("overwrite")]),t._v(" "),a("code",[t._v("{Boolean}")]),t._v("：相同的 "),a("code",[t._v("Key")]),t._v(" 的处理逻辑，为 true，则后设置的值会覆盖前面设置的，否则将会发送两个 "),a("code",[t._v("Set-Cookie")]),t._v(" 响应头。")])]),t._v(" "),a("h3",{attrs:{id:"配置秘钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置秘钥","aria-hidden":"true"}},[t._v("#")]),t._v(" 配置秘钥")]),t._v(" "),a("p",[t._v("由于我们在 "),a("code",[t._v("Cookie")]),t._v(" 中需要用到"),a("code",[t._v("加解密")]),t._v("和"),a("code",[t._v("验签")]),t._v("，所以需要配置一个秘钥供加密使用。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// config/config.default.js")]),t._v("\nmodule"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  keys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'key1,key2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("如果你没配置该属性，则在访问时会报错：")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("ERROR 17996 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("-/::1/-/7ms GET /"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" nodejs.Error: Please "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" config.keysfirst\n")])])]),a("p",[a("code",[t._v("keys")]),t._v(" 配置成一个字符串，可以按照逗号分隔配置多个 key。")]),t._v(" "),a("p",[a("code",[t._v("Cookie")]),t._v(" 在使用这个配置进行加解密时：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("加密")]),t._v("和"),a("code",[t._v("加签")]),t._v("时只会使用第一个秘钥。")]),t._v(" "),a("li",[a("code",[t._v("解密")]),t._v("和"),a("code",[t._v("验签")]),t._v("时会遍历 "),a("code",[t._v("keys")]),t._v(" 进行解密。")])]),t._v(" "),a("p",[t._v("如果我们想要更新 "),a("code",[t._v("Cookie")]),t._v(" 的秘钥，但是又不希望之前设置到用户浏览器上的 "),a("code",[t._v("Cookie")]),t._v(" 失效，可以将新的秘钥配置到 "),a("code",[t._v("keys")]),t._v(" 最前面，等过一段时间之后再删去不需要的秘钥即可。")]),t._v(" "),a("h2",{attrs:{id:"cookie-实战"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cookie-实战","aria-hidden":"true"}},[t._v("#")]),t._v(" Cookie 实战")]),t._v(" "),a("h3",{attrs:{id:"读取前端写入的-cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#读取前端写入的-cookie","aria-hidden":"true"}},[t._v("#")]),t._v(" 读取前端写入的 Cookie")]),t._v(" "),a("p",[t._v("如果要获取前端或者其他系统设置的 "),a("code",[t._v("Cookie")]),t._v("，需要指定参数 "),a("code",[t._v("signed")]),t._v(" 为 "),a("code",[t._v("false")]),t._v("，避免对它做验签导致获取不到 "),a("code",[t._v("Cookie")]),t._v(" 的值。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'frontend-cookie'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  signed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"允许前端读取-cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#允许前端读取-cookie","aria-hidden":"true"}},[t._v("#")]),t._v(" 允许前端读取 Cookie")]),t._v(" "),a("p",[t._v("如果想要 "),a("code",[t._v("Cookie")]),t._v(" 在浏览器端可以被 js 访问并修改:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  httpOnly"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  signed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"不允许浏览器看到明文内容"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#不允许浏览器看到明文内容","aria-hidden":"true"}},[t._v("#")]),t._v(" 不允许浏览器看到明文内容")]),t._v(" "),a("p",[t._v("如果想要 "),a("code",[t._v("Cookie")]),t._v(" 在浏览器端不能被修改，不能看到明文：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  httpOnly"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认就是 true")]),t._v("\n  encrypt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 加密传输")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h3",{attrs:{id:"删除-cookie"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除-cookie","aria-hidden":"true"}},[t._v("#")]),t._v(" 删除 Cookie")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[t._v("ctx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookies"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"编写测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#编写测试","aria-hidden":"true"}},[t._v("#")]),t._v(" 编写测试")]),t._v(" "),a("p",[t._v("类似 "),a("router-link",{attrs:{to:"/zh/guide/controller.html"}},[t._v("Controller")]),t._v(" 的测试。")],1),t._v(" "),a("p",[t._v("需注意的是：模拟 "),a("code",[t._v("Cookies")]),t._v(" 可能需要加上对应的 "),a("code",[t._v("sig")]),t._v(" 加签信息。")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// test/controller/cookies.test.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" mock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" assert "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'egg-mock'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("describe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'test/controller/cookies.test.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("it")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'should GET /'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("httpRequest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/cookies'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("set")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'cookie'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'name=tz; path=/; httponly,name.sig=KdTywxAfCA4vHc1fmNipTZ9zPhBatn1br5tXWomvO14; path=/; httponly'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("expect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'set-cookie'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/uid=123;/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("expect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("具体的单元测试运行方式，参见 "),a("router-link",{attrs:{to:"/zh/workflow/development/unittest.html"}},[t._v("研发流程 - 单元测试")]),t._v(" 文档。")],1),t._v(" "),a("h2",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项","aria-hidden":"true"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),a("ol",[a("li",[t._v("由于"),a("a",{attrs:{href:"http://stackoverflow.com/questions/7567154/can-i-use-unicode-characters-in-http-headers",target:"_blank",rel:"noopener noreferrer"}},[t._v("浏览器和其他客户端实现的不确定性"),a("OutboundLink")],1),t._v("，为了保证 Cookie 可以写入成功，建议 value 通过 base64 编码或者其他形式 encode 之后再写入。")]),t._v(" "),a("li",[t._v("由于"),a("a",{attrs:{href:"http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key",target:"_blank",rel:"noopener noreferrer"}},[t._v("浏览器对 Cookie 有长度限制限制"),a("OutboundLink")],1),t._v("，所以尽量不要设置太长的 Cookie。一般来说不要超过 4093 bytes。当设置的 Cookie value 大于这个值时，框架会打印一条警告日志。")]),t._v(" "),a("li",[a("strong",[t._v("尽可能少写入数据到 Cookie")]),t._v("。")])])])},[],!1,null,null,null);s.default=n.exports}}]);