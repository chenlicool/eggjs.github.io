<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>异常处理 | Egg</title>
    <meta name="description" content="为企业级框架和应用而生">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
    
    <link rel="preload" href="/assets/css/0.styles.4659e948.css" as="style"><link rel="preload" href="/assets/js/app.77aa8c4f.js" as="script"><link rel="preload" href="/assets/js/3.dcc3f7c0.js" as="script"><link rel="preload" href="/assets/js/1.afc15f94.js" as="script"><link rel="preload" href="/assets/js/22.828a3b43.js" as="script"><link rel="prefetch" href="/assets/js/10.1d10814c.js"><link rel="prefetch" href="/assets/js/11.5abde44a.js"><link rel="prefetch" href="/assets/js/12.2889c771.js"><link rel="prefetch" href="/assets/js/13.5756d463.js"><link rel="prefetch" href="/assets/js/14.76791e11.js"><link rel="prefetch" href="/assets/js/15.496a396e.js"><link rel="prefetch" href="/assets/js/16.b174f96e.js"><link rel="prefetch" href="/assets/js/17.7da596f5.js"><link rel="prefetch" href="/assets/js/18.a0b1deac.js"><link rel="prefetch" href="/assets/js/19.e65fcbf6.js"><link rel="prefetch" href="/assets/js/20.a4fb7e93.js"><link rel="prefetch" href="/assets/js/21.ff93a132.js"><link rel="prefetch" href="/assets/js/23.6397e5b9.js"><link rel="prefetch" href="/assets/js/24.9be1b01e.js"><link rel="prefetch" href="/assets/js/25.32f81bbe.js"><link rel="prefetch" href="/assets/js/26.2b5d15f2.js"><link rel="prefetch" href="/assets/js/27.3f5677d2.js"><link rel="prefetch" href="/assets/js/28.29168215.js"><link rel="prefetch" href="/assets/js/29.dd5dfed9.js"><link rel="prefetch" href="/assets/js/30.b6d90030.js"><link rel="prefetch" href="/assets/js/31.1141f7ac.js"><link rel="prefetch" href="/assets/js/32.dfb8cc9e.js"><link rel="prefetch" href="/assets/js/33.0955b641.js"><link rel="prefetch" href="/assets/js/34.bdc8e075.js"><link rel="prefetch" href="/assets/js/35.eeb51878.js"><link rel="prefetch" href="/assets/js/4.3e5c2d0b.js"><link rel="prefetch" href="/assets/js/5.b83169a7.js"><link rel="prefetch" href="/assets/js/6.b736b694.js"><link rel="prefetch" href="/assets/js/7.a26c7040.js"><link rel="prefetch" href="/assets/js/8.cf9e16b0.js"><link rel="prefetch" href="/assets/js/9.7106307e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4659e948.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <div class="left-logo-part"><a href="/zh/" class="home-link router-link-active"><img src="/logo.svg" alt="Egg" class="logo"> <span class="site-name can-hide">Egg</span></a> <div placeholder="在 Egg 中搜索" class="egg-search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value="" placeholder="在 Egg 中搜索"> <!----></div></div> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item dropdown-item-single"><h4><a href="/" class="nav-link">English</a></h4> <!----></li><li class="dropdown-item dropdown-item-single"><h4><a href="/zh/guide/error_handler.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></h4> <!----></li></ul></div></div> <div class="nav-item"><a href="https://github.com/eggjs/eggjs.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></nav></div></header> <div class="sidebar-mask"></div> <aside stick="foot" class="sticker sidebar"><div class="sidebar-wrap"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item dropdown-item-single"><h4><a href="/" class="nav-link">English</a></h4> <!----></li><li class="dropdown-item dropdown-item-single"><h4><a href="/zh/guide/error_handler.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></h4> <!----></li></ul></div></div> <div class="nav-item"><a href="https://github.com/eggjs/eggjs.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></nav>  <ul class="sidebar-links"><li><section class="sidebar-item"><a href="/zh/guide/" class="sidebar-item-heading router-link-active"><!---->
    概述
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/directory.html" class="sidebar-item-heading"><!---->
    目录规范
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/middleware.html" class="sidebar-item-heading"><!---->
    Middleware
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/controller.html" class="sidebar-item-heading"><!---->
    Controller
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/router.html" class="sidebar-item-heading"><!---->
    Router
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/service.html" class="sidebar-item-heading"><!---->
    Service
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/application.html" class="sidebar-item-heading"><!---->
    Application
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/context.html" class="sidebar-item-heading"><!---->
    Context
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/config.html" class="sidebar-item-heading"><!---->
    配置
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/logger.html" class="sidebar-item-heading"><!---->
    日志
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/cookie.html" class="sidebar-item-heading"><!---->
    Cookie
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/session.html" class="sidebar-item-heading"><!---->
    Session
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/helper.html" class="sidebar-item-heading"><!---->
    Helper
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/httpclient.html" class="sidebar-item-heading"><!---->
    HttpClient
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/error_handler.html" class="sidebar-item-heading router-link-exact-active router-link-active"><!---->
    异常处理
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/lifecycle.html" class="sidebar-item-heading"><!---->
    生命周期
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/plugin.html" class="sidebar-item-heading"><!---->
    使用插件
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/upload.html" class="sidebar-item-heading"><!---->
    文件上传
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/i18n.html" class="sidebar-item-heading"><!---->
    国际化
  </a> <!----></section></li></ul> </div></aside> <main class="page"> <div class="content content__default"><h1 id="异常处理"><a href="#异常处理" aria-hidden="true" class="header-anchor">#</a> 异常处理</h1> <h2 id="使用场景"><a href="#使用场景" aria-hidden="true" class="header-anchor">#</a> 使用场景</h2> <p>健壮性，是一个应用的基本要求。如何正确的处理错误是非常重要的一件事。</p> <p>实际开发中，错误可以分为几类：</p> <ul><li>非期望的入参，如函数要求传递的是数值，却传递了字符串。</li> <li>意料之中的错误，如 <code>Http 网络断开</code>、<code>文件不存在</code>等。</li> <li>完全意料之外的异常，譬如业务进程被外部杀死。</li></ul> <p>错误的处理也有一些通用的实践：</p> <ul><li>需要记录错误的信息，位置，堆栈和上下文。</li> <li>根据内容协商来返回不同的响应格式。</li> <li>正式环境下，不能把详细的错误信息和堆栈抛到用户侧。</li></ul> <h2 id="node-js-异常处理"><a href="#node-js-异常处理" aria-hidden="true" class="header-anchor">#</a> Node.js 异常处理</h2> <p>在 <code>Node.js</code> 里，对异常的处理非常重要，如果有<code>未捕获异常</code>会直接导致进程退出。</p> <p>在早期的 <code>Node.js</code> 里， <a href="https://nodejs.org/api/errors.html#errors_error_first_callbacks" target="_blank" rel="noopener noreferrer">Error-first callbacks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是用的比较广泛的一种错误处理的约定。</p> <p>但嵌套层次一多起来，就需要一层层的往上抛出，非常容易遗漏和出现问题。</p> <p>因此，在 <code>Async Function</code> 异步编程模型出来后，通过 <code>try..catch</code> 来捕获错误，就直观了很多。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>service<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'create user fail'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意事项</p> <p>避免使用 <code>callback</code>，它抛出的错误，无法被 <code>try</code> 直接捕获，详见 <a href="https://nodejs.org/api/errors.html" target="_blank" rel="noopener noreferrer">Node.js Error<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p></div> <h2 id="框架内置支持"><a href="#框架内置支持" aria-hidden="true" class="header-anchor">#</a> 框架内置支持</h2> <p>框架内置了 <a href="https://github.com/eggjs/egg-onerror" target="_blank" rel="noopener noreferrer">onerror<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件，提供了统一的错误处理机制。</p> <p>对一个请求处理过程中的 <code>Middleware</code>、<code>Controller</code>、<code>Service</code> 等抛出的任何异常都会被它捕获。</p> <h2 id="业务错误处理"><a href="#业务错误处理" aria-hidden="true" class="header-anchor">#</a> 业务错误处理</h2> <p>如果你需要对业务错误进行统一处理，可以如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/middleware/error_handler.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
      <span class="token comment">// 所有的异常都在 app 上触发一个 error 事件，框架会记录一条错误日志</span>
      app<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">const</span> status <span class="token operator">=</span> err<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span><span class="token punctuation">;</span>

      <span class="token comment">// 生产环境时 500 错误的详细错误内容不返回给客户端，因为可能包含敏感信息</span>
      <span class="token keyword">const</span> error <span class="token operator">=</span> status <span class="token operator">===</span> <span class="token number">500</span> <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>env <span class="token operator">===</span> <span class="token string">'prod'</span> <span class="token operator">?</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">;</span>

      <span class="token comment">// 仅供参考，需按自己的业务逻辑处理。</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>挂载中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  middleware<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'errorHandler'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  errorHandler<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 仅对该路径下的接口处理</span>
    match<span class="token punctuation">:</span> <span class="token string">'/api'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="框架兜底处理"><a href="#框架兜底处理" aria-hidden="true" class="header-anchor">#</a> 框架兜底处理</h2> <p>框架通过 <a href="https://github.com/eggjs/egg-onerror" target="_blank" rel="noopener noreferrer">onerror<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件提供了统一的错误处理机制。</p> <p>对一个请求的所有处理方法（<code>Middleware</code>、<code>Controller</code>、<code>Service</code>）中抛出的任何异常都会被它捕获。</p> <p>并自动根据请求想要获取的类型返回不同类型的错误（基于 <a href="https://tools.ietf.org/html/rfc7231#section-5.3.2" target="_blank" rel="noopener noreferrer">Content Negotiation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）。</p> <table><thead><tr><th>请求需求的格式</th> <th>环境</th> <th>errorPageUrl 是否配置</th> <th>返回内容</th></tr></thead> <tbody><tr><td>HTML &amp; TEXT</td> <td>local &amp; unittest</td> <td>-</td> <td>onerror 自带的错误页面，展示详细的错误信息</td></tr> <tr><td>HTML &amp; TEXT</td> <td>其他</td> <td>是</td> <td>重定向到 errorPageUrl</td></tr> <tr><td>HTML &amp; TEXT</td> <td>其他</td> <td>否</td> <td>onerror 自带的没有错误信息的简单错误页（不推荐）</td></tr> <tr><td>JSON &amp; JSONP</td> <td>local &amp; unittest</td> <td>-</td> <td>JSON 对象或对应的 JSONP 格式响应，带详细的错误信息</td></tr> <tr><td>JSON &amp; JSONP</td> <td>其他</td> <td>-</td> <td>JSON 对象或对应的 JSONP 格式响应，不带详细的错误信息</td></tr></tbody></table> <h3 id="errorpageurl"><a href="#errorpageurl" aria-hidden="true" class="header-anchor">#</a> errorPageUrl</h3> <p><code>onerror</code> 插件支持 <code>errorPageUrl</code> 配置，当配置了 <code>errorPageUrl</code> 时，一旦用户请求线上应用的 HTML 页面异常，就会重定向到这个地址。</p> <p>在 <code>config/config.default.js</code> 中</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  onerror<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 线上页面发生异常时，重定向到这个页面上</span>
    errorPageUrl<span class="token punctuation">:</span> <span class="token string">'/50x.html'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="自定义统一异常处理"><a href="#自定义统一异常处理" aria-hidden="true" class="header-anchor">#</a> 自定义统一异常处理</h3> <p>尽管框架提供了默认的统一异常处理机制，但是应用开发中经常需要对异常时的响应做自定义，特别是在做一些接口开发的时候。框架自带的 <code>onerror</code> 插件支持自定义配置错误处理方法，可以覆盖默认的错误处理方法。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  onerror<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 在此处定义针对所有响应类型的错误处理方法</span>
      <span class="token comment">// 注意，定义了 config.all 之后，其他错误处理方法不会再生效</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">html</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// html hander</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;h3&gt;error&lt;/h3&gt;'</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">json</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// json hander</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> message<span class="token punctuation">:</span> <span class="token string">'error'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> ctx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 一般来说，不需要特殊针对 jsonp 进行错误定义，jsonp 的错误处理会自动调用 json 错误处理，并包装成 jsonp 的响应格式</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_404"><a href="#_404" aria-hidden="true" class="header-anchor">#</a> 404</h2> <p><code>404 - NOT FOUND</code> 是我们比较熟悉的一种错误。</p> <p>框架并不是把它视为是一种异常，并在上面的兜底流程做处理，而是另行提供了处理逻辑。</p> <h3 id="默认返回值"><a href="#默认返回值" aria-hidden="true" class="header-anchor">#</a> 默认返回值</h3> <p>如果一次用户请求，经过了 <code>Middleware</code> 和 <code>Controller</code> 处理后，对应的 <code>ctx.body</code> 和 <code>ctx.status</code> 都未被赋值时，框架会视为 <code>404</code>。</p> <p>此时框架会默认根据 <code>Accepet</code> 头来响应对应的值：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Accpet: application/json</span>
<span class="token punctuation">{</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;Not Found&quot;</span> <span class="token punctuation">}</span>

<span class="token comment">// Accept: text/html</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span><span class="token number">404</span> Not Found<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
</code></pre></div><h3 id="重定向"><a href="#重定向" aria-hidden="true" class="header-anchor">#</a> 重定向</h3> <p>框架也支持通过配置，将默认的 HTML 请求的 404 响应重定向到指定的页面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  notfound<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 也可以是一个统一的 404 外链</span>
    pageUrl<span class="token punctuation">:</span> <span class="token string">'/404.html'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="自定义-404-响应"><a href="#自定义-404-响应" aria-hidden="true" class="header-anchor">#</a> 自定义 404 响应</h3> <p>在一些场景下，我们需要自定义服务器 404 时的响应，只需要加入一个中间件即可统一处理：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/middleware/notfound_handler.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">notFoundHandler</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>ctx<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>acceptJSON<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span> error<span class="token punctuation">:</span> <span class="token string">'Not Found'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;h1&gt;Page Not Found&lt;/h1&gt;'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>挂载中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  middleware<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'notfoundHandler'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="常见问题"><a href="#常见问题" aria-hidden="true" class="header-anchor">#</a> 常见问题</h2> <h3 id="该不该-catch"><a href="#该不该-catch" aria-hidden="true" class="header-anchor">#</a> 该不该 Catch</h3> <p>具体情况具体分析，没有绝对的银弹。</p> <p>如果错误是非主流程的，是可选的，那可以自行兜底处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/service/ad.js</span>
<span class="token keyword">class</span> <span class="token class-name">AdService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 查询推荐的广告位数据，失败则返回空。</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>db<span class="token punctuation">.</span>ad<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 打印错误日志</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'list ad fail'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回空数据，不影响主流程</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果对应的错误，是需要告知用户或通知前端代码的，那可以通过上述的 <a href="#%E4%B8%9A%E5%8A%A1%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86">业务错误处理</a> 来统一反馈给用户。</p> <h3 id="回调错误无法捕获"><a href="#回调错误无法捕获" aria-hidden="true" class="header-anchor">#</a> 回调错误无法捕获</h3> <p>按照正常代码写法，所有的异常都可以用这个方式进行捕获并处理，但是一定要注意一些特殊的写法可能带来的问题。</p> <p>打一个不太正式的比方，我们的代码全部都在一个异步调用链上，所有的异步操作都通过 <code>await</code> 串接起来了，但是只要有一个地方跳出了异步调用链，异常就捕获不到了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/home.js</span>
<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">error</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在回调里面抛错</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'this is an error throw from callback'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正确的做法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/home.js</span>
<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">buy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>trade<span class="token punctuation">.</span><span class="token function">buy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token punctuation">:</span> <span class="token string">'12345'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下单后需要进行一次核对，且不阻塞当前请求</span>
    <span class="token function">setImmediate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>trade<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在这个场景中，如果 <code>service.trade.check</code> 方法中代码有问题，导致执行时抛出了异常，尽管框架会在最外层通过 <code>try catch</code> 统一捕获错误，但是由于 <code>setImmediate</code> 中的代码『跳出』了异步链，它里面的错误就无法被捕捉到了。因此在编写类似代码的时候一定要注意。</p> <p>当然，框架也考虑到了这类场景，提供了 <code>ctx.runInBackground(scope)</code> 辅助方法，通过它又包装了一个异步链，所有在这个 scope 里面的错误都会统一捕获。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">buy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>trade<span class="token punctuation">.</span><span class="token function">buy</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 下单后需要进行一次核对，且不阻塞当前请求</span>
    ctx<span class="token punctuation">.</span><span class="token function">runInBackground</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这里面的异常都会统统被 Backgroud 捕获掉，并打印错误日志</span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>trade<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="edit-link"><a href="https://github.com/eggjs/eggjs.github.io/blob/docs/docs/zh/guide/error_handler.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></footer> <div class="page-nav"><p class="inner"><a href="/zh/guide/httpclient.html" title="HttpClient" class="prev">
        上一篇<br><span>HttpClient</span></a> <a href="/zh/guide/lifecycle.html" title="生命周期" class="next">
        下一篇<br><span>生命周期</span></a></p></div> </main> <div class="global-foot"><div class="friend-links"><div class="friend-list-wrapper"><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Github</div> <a href="https://github.com/eggjs" target="_blank" class="friend-list-item">Organization</a><a href="https://github.com/eggjs/examples" target="_blank" class="friend-list-item">Example</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Links</div> <a href="https://ant.design" target="_blank" class="friend-list-item">Ant Design</a><a href="http://motion.ant.design/" target="_blank" class="friend-list-item">Ant Motion</a><a href="https://antv.alipay.com/" target="_blank" class="friend-list-item">Antv</a><a href="https://umijs.org/" target="_blank" class="friend-list-item">Umi.js</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Community</div> <a href="https://eggjs.org/zh-cn/faq.html" target="_blank" class="friend-list-item">FAQ</a><a href="https://www.yuque.com/egg/nodejs" target="_blank" class="friend-list-item">Node.js Column</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Egg.js Dingtalk</div>  <div class="friend-qrcode"><img src="/egg/qrcode_dingtalk.png"></div></div></div></div></div> <div class="copyright"><span class="span"><span>Copyright © 2019 Egg.js</span></span></div></div> <div stick="foot" class="sticker egg-toc"><div class="egg-toc-item egg-toc-h2 active"><a href="#使用场景" title="使用场景">使用场景</a></div><div class="egg-toc-item egg-toc-h2"><a href="#node-js-异常处理" title="Node.js 异常处理">Node.js 异常处理</a></div><div class="egg-toc-item egg-toc-h2"><a href="#框架内置支持" title="框架内置支持">框架内置支持</a></div><div class="egg-toc-item egg-toc-h2"><a href="#业务错误处理" title="业务错误处理">业务错误处理</a></div><div class="egg-toc-item egg-toc-h2"><a href="#框架兜底处理" title="框架兜底处理">框架兜底处理</a></div><div class="egg-toc-item egg-toc-h3"><a href="#errorpageurl" title="errorPageUrl">errorPageUrl</a></div><div class="egg-toc-item egg-toc-h3"><a href="#自定义统一异常处理" title="自定义统一异常处理">自定义统一异常处理</a></div><div class="egg-toc-item egg-toc-h2"><a href="#_404" title="404">404</a></div><div class="egg-toc-item egg-toc-h3"><a href="#默认返回值" title="默认返回值">默认返回值</a></div><div class="egg-toc-item egg-toc-h3"><a href="#重定向" title="重定向">重定向</a></div><div class="egg-toc-item egg-toc-h3"><a href="#自定义-404-响应" title="自定义 404 响应">自定义 404 响应</a></div><div class="egg-toc-item egg-toc-h2"><a href="#常见问题" title="常见问题">常见问题</a></div><div class="egg-toc-item egg-toc-h3"><a href="#该不该-catch" title="该不该 Catch">该不该 Catch</a></div><div class="egg-toc-item egg-toc-h3"><a href="#回调错误无法捕获" title="回调错误无法捕获">回调错误无法捕获</a></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.77aa8c4f.js" defer></script><script src="/assets/js/3.dcc3f7c0.js" defer></script><script src="/assets/js/1.afc15f94.js" defer></script><script src="/assets/js/22.828a3b43.js" defer></script>
  </body>
</html>
