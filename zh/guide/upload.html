<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>文件上传 | Egg</title>
    <meta name="description" content="为企业级框架和应用而生">
    
    
    <link rel="preload" href="/assets/css/0.styles.5203916d.css" as="style"><link rel="preload" href="/assets/js/app.317272b7.js" as="script"><link rel="preload" href="/assets/js/2.7bd862e7.js" as="script"><link rel="preload" href="/assets/js/30.dcc0f8a4.js" as="script"><link rel="prefetch" href="/assets/js/10.c3972b62.js"><link rel="prefetch" href="/assets/js/11.e9585f68.js"><link rel="prefetch" href="/assets/js/12.3815fe1e.js"><link rel="prefetch" href="/assets/js/13.5e06d49d.js"><link rel="prefetch" href="/assets/js/14.3b6fddd8.js"><link rel="prefetch" href="/assets/js/15.494082f6.js"><link rel="prefetch" href="/assets/js/16.b546ed30.js"><link rel="prefetch" href="/assets/js/17.97cab730.js"><link rel="prefetch" href="/assets/js/18.bbddf561.js"><link rel="prefetch" href="/assets/js/19.1c667745.js"><link rel="prefetch" href="/assets/js/20.79b3431f.js"><link rel="prefetch" href="/assets/js/21.4be0f224.js"><link rel="prefetch" href="/assets/js/22.36f8502b.js"><link rel="prefetch" href="/assets/js/23.4a400231.js"><link rel="prefetch" href="/assets/js/24.e0d88e74.js"><link rel="prefetch" href="/assets/js/25.e176e978.js"><link rel="prefetch" href="/assets/js/26.e04f1b85.js"><link rel="prefetch" href="/assets/js/27.46820c07.js"><link rel="prefetch" href="/assets/js/28.56abde8a.js"><link rel="prefetch" href="/assets/js/29.4e4c2114.js"><link rel="prefetch" href="/assets/js/3.e44b477d.js"><link rel="prefetch" href="/assets/js/31.7a987d06.js"><link rel="prefetch" href="/assets/js/32.28875310.js"><link rel="prefetch" href="/assets/js/4.d58994b3.js"><link rel="prefetch" href="/assets/js/5.10b31697.js"><link rel="prefetch" href="/assets/js/6.3a86b35b.js"><link rel="prefetch" href="/assets/js/7.bb785290.js"><link rel="prefetch" href="/assets/js/8.80b3eee6.js"><link rel="prefetch" href="/assets/js/9.3f5434be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5203916d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">Egg</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/upload.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/upload.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/zh/guide/" class="sidebar-link">概述</a></li><li><a href="/zh/guide/directory.html" class="sidebar-link">目录规范</a></li><li><a href="/zh/guide/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/zh/guide/controller.html" class="sidebar-link">Controller</a></li><li><a href="/zh/guide/router.html" class="sidebar-link">Router</a></li><li><a href="/zh/guide/service.html" class="sidebar-link">Service</a></li><li><a href="/zh/guide/application.html" class="sidebar-link">Application</a></li><li><a href="/zh/guide/context.html" class="sidebar-link">Context</a></li><li><a href="/zh/guide/config.html" class="sidebar-link">配置</a></li><li><a href="/zh/guide/logger.html" class="sidebar-link">日志</a></li><li><a href="/zh/guide/cookie.html" class="sidebar-link">Cookie</a></li><li><a href="/zh/guide/session.html" class="sidebar-link">Session</a></li><li><a href="/zh/guide/helper.html" class="sidebar-link">Helper</a></li><li><a href="/zh/guide/httpclient.html" class="sidebar-link">HttpClient</a></li><li><a href="/zh/guide/error_handler.html" class="sidebar-link">异常处理</a></li><li><a href="/zh/guide/lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/zh/guide/plugin.html" class="sidebar-link">使用插件</a></li><li><a href="/zh/guide/upload.html" class="active sidebar-link">文件上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/upload.html#使用场景" class="sidebar-link">使用场景</a></li><li class="sidebar-sub-header"><a href="/zh/guide/upload.html#file-模式" class="sidebar-link">File 模式</a></li><li class="sidebar-sub-header"><a href="/zh/guide/upload.html#stream-模式" class="sidebar-link">Stream 模式</a></li><li class="sidebar-sub-header"><a href="/zh/guide/upload.html#安全限制" class="sidebar-link">安全限制</a></li><li class="sidebar-sub-header"><a href="/zh/guide/upload.html#云存储" class="sidebar-link">云存储</a></li></ul></li><li><a href="/zh/guide/i18n.html" class="sidebar-link">国际化</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="使用场景"><a href="#使用场景" aria-hidden="true" class="header-anchor">#</a> 使用场景</h2> <p>文件上传，是 Web 应用的一个常见的功能。</p> <p>框架内置了 <a href="https://github.com/eggjs/egg-multipart" target="_blank" rel="noopener noreferrer">Multipart<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件：</p> <ul><li>解析浏览器上传的 <code>multipart/form-data</code> 的数据。</li> <li>提供 <code>file</code> 和 <code>stream</code> 两种处理接口供开发者选择。</li> <li>默认提供了安全的限制。</li></ul> <p>获取到用户上传的数据后，开发者可以：</p> <ul><li>存储为本地文件。</li> <li>提交给第三方服务，参见 <a href="/zh/guide/httpclient.html">通过 HttpClient 上传文件</a>。</li> <li>大部分情况下，我们会转存给<strong>云存储服务</strong>，在本文中我们也会一并介绍到。</li></ul> <h2 id="file-模式"><a href="#file-模式" aria-hidden="true" class="header-anchor">#</a> <code>File</code> 模式</h2> <p>虽然在 <code>Node.js</code> 的世界里面，<a href="https://nodejs.org/api/stream.html" target="_blank" rel="noopener noreferrer">Stream<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 才是主流。</p> <p>但对于一般开发者来说，<code>Stream</code> 并不是很容易掌握，尤其是错误处理环节。</p> <p>因此，框架提供了 <code>File</code> 模式来简化开发。</p> <p>相关的示例代码参见：<a href="https://github.com/eggjs/examples/tree/master/multipart-file-mode" target="_blank" rel="noopener noreferrer">eggjs/example/multipart-file-mode<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="配置"><a href="#配置" aria-hidden="true" class="header-anchor">#</a> 配置</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
config<span class="token punctuation">.</span>multipart <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token punctuation">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="前端代码"><a href="#前端代码" aria-hidden="true" class="header-anchor">#</a> 前端代码</h3> <p>前端可以通过 <code>Form</code> 或 <code>AJAX</code> 等方式来上传文件。</p> <p>譬如：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/upload?_csrf={{ ctx.csrf | safe }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  title: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file1: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file1<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  file2: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file2<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">注意事项</p> <p>文件上传需要通过 <code>POST</code> 协议，因此会受到 <a href="/zh/ecosystem/security/csrf.html">CSRF</a> 安全的管控，具体参见对应文档。</p></div> <h3 id="获取上传的文件"><a href="#获取上传的文件" aria-hidden="true" class="header-anchor">#</a> 获取上传的文件</h3> <p>框架在 <code>File</code> 模式下，会把获取到的文件挂载到 <code>ctx.request.files</code> 数组上。</p> <p>关键代码：</p> <ul><li><code>ctx.request.files</code>: 获取到的文件列表。</li> <li><code>ctx.oss.put()</code>：示例代码，此处为上传到 OSS 云存储，下文会介绍到。</li> <li><code>ctx.cleanupRequestFiles()</code>：处理完毕后，清理临时文件。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/controller/upload.js</span>
<span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'got %d files'</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历处理多个文件</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> file <span class="token keyword">of</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'filename: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encoding: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mime: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>mime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'tmp filepath: '</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 处理文件，比如上传到云端</span>
        <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> file<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token comment">// 需要删除临时文件</span>
      <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">cleanupRequestFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h2 id="stream-模式"><a href="#stream-模式" aria-hidden="true" class="header-anchor">#</a> <code>Stream</code> 模式</h2> <p>如果你对于 <code>Node.js</code> 中的 <code>Stream</code> 模式非常熟悉，那么你可以选择此模式。</p> <p>相关的示例代码参见：<a href="https://github.com/eggjs/examples/tree/master/multipart" target="_blank" rel="noopener noreferrer">eggjs/example/multipart<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="上传单个文件"><a href="#上传单个文件" aria-hidden="true" class="header-anchor">#</a> 上传单个文件</h3> <p>框架同样提供了简化开发的语法糖：</p> <ul><li><code>ctx.getFileStream()</code>：获取上传的文件流，仅支持上传一个文件的情况。</li> <li><code>stream.fields</code> 获取其他表单字段。</li></ul> <div class="warning custom-block"><p class="custom-block-title">注意事项</p> <p>由于表单解析是有时序的，因此前端代码中，<code>文件 fileds</code> 必须在最后面。</p> <p>否则在拿到文件流时，<code>stream.fields</code> 还没解析完，从而获取不到。</p></div> <p>因此对应的前端代码：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>POST<span class="token punctuation">&quot;</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/upload?_csrf={{ ctx.csrf | safe }}<span class="token punctuation">&quot;</span></span> <span class="token attr-name">enctype</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>multipart/form-data<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  title: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>

  <span class="token comment">&lt;!-- 只能有一个 File，且必须放在最后--&gt;</span>
  file: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>file<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submit<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Upload<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对应的后端代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> sendToWormhole <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-wormhole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">getFileStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>stream<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 文件处理，上传到云存储等等</span>
    <span class="token keyword">let</span> result<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 必须将上传的文件流消费掉，要不然浏览器响应会卡死</span>
      <span class="token keyword">await</span> <span class="token function">sendToWormhole</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      url<span class="token punctuation">:</span> result<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
      <span class="token comment">// 所有表单字段都能通过 `stream.fields` 获取到</span>
      fields<span class="token punctuation">:</span> stream<span class="token punctuation">.</span>fields<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="上传多个文件"><a href="#上传多个文件" aria-hidden="true" class="header-anchor">#</a> 上传多个文件</h3> <p>同时上传多个文件的场景，不能通过 <code>ctx.getFileStream()</code> 来获取，只能通过以下方式：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> sendToWormhole <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream-wormhole'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">;</span>
    <span class="token keyword">const</span> parts <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">multipart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> part<span class="token punctuation">;</span>
    <span class="token comment">// parts() 返回 promise 对象</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>part <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">parts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>part<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这是 busboy 的字段</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'valueTruncated: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fieldnameTruncated: '</span> <span class="token operator">+</span> part<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>part<span class="token punctuation">.</span>filename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 这时是用户没有选择文件就点击了上传(part 是 file stream，但是 part.filename 为空)</span>
          <span class="token comment">// 需要做出处理，例如给出错误提示消息</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// part 是上传的文件流</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'field: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>fieldname<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'filename: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'encoding: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>encoding<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'mime: '</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>mime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 文件处理，上传到云存储等等</span>
        <span class="token keyword">let</span> result<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'egg-multipart-test/'</span> <span class="token operator">+</span> part<span class="token punctuation">.</span>filename<span class="token punctuation">,</span> part<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 必须将上传的文件流消费掉，要不然浏览器响应会卡死</span>
          <span class="token keyword">await</span> <span class="token function">sendToWormhole</span><span class="token punctuation">(</span>part<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">throw</span> err<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'and we are done parsing the form!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><h3 id="错误处理"><a href="#错误处理" aria-hidden="true" class="header-anchor">#</a> 错误处理</h3> <p><code>Stream</code> 模式下，在异常处理里面，<strong>必须将上传的文件流消费掉，要不然浏览器响应会卡死</strong>。</p> <p>如上示例，你可以使用 <a href="https://github.com/node-modules/stream-wormhole" target="_blank" rel="noopener noreferrer">stream-wormhole<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 和 <a href="https://github.com/node-modules/mz-modules" target="_blank" rel="noopener noreferrer">mz-modules/pump<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块来处理。</p> <div class="warning custom-block"><p class="custom-block-title">友情提示</p> <p>如果你对 <code>Stream</code> 没有足够了解的时候，建议直接使用 <code>File</code> 模式。</p></div> <h2 id="安全限制"><a href="#安全限制" aria-hidden="true" class="header-anchor">#</a> 安全限制</h2> <h3 id="文件大小"><a href="#文件大小" aria-hidden="true" class="header-anchor">#</a> 文件大小</h3> <p>为了避免恶意的攻击，框架默认对文件上传接口，限制了 <code>File</code> 和 <code>Field</code> 的个数和大小。</p> <p>默认配置如下，开发者可以根据需求修改对应的配置。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>config<span class="token punctuation">.</span>multipart <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 表单 Field 文件名长度限制</span>
  fieldNameSize<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
  <span class="token comment">// 表单 Field 内容大小</span>
  fieldSize<span class="token punctuation">:</span> <span class="token string">'100kb'</span><span class="token punctuation">,</span>
  <span class="token comment">// 表单 Field 最大个数</span>
  fields<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>

  <span class="token comment">// 单个文件大小</span>
  fileSize<span class="token punctuation">:</span> <span class="token string">'10mb'</span><span class="token punctuation">,</span>
  <span class="token comment">// 允许上传的最大文件数</span>
  files<span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其中，<code>fileSize</code> 支持 <code>10mb</code> 这种人性化的方式，具体参见 <a href="https://github.com/node-modules/humanize-bytes" target="_blank" rel="noopener noreferrer">humanize-bytes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块。</p> <h3 id="文件类型"><a href="#文件类型" aria-hidden="true" class="header-anchor">#</a> 文件类型</h3> <p>为了保证文件上传的安全，框架限制了支持的文件格式。默认的后缀白名单参见<a href="https://github.com/eggjs/egg-multipart/blob/master/app.js#L23" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>开发者可以通过配置 <code>fileExtensions</code> 来新增允许的类型：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  multipart<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    fileExtensions<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'.apk'</span> <span class="token punctuation">]</span> <span class="token comment">// 增加对 apk 扩展名的文件支持</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如果你希望覆盖框架内置的白名单，可以配置 <code>whitelist</code> 属性：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  multipart<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 覆盖整个白名单，只允许上传 '.png' 格式</span>
    whitelist<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">'.png'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 也支持函数格式</span>
    <span class="token comment">// whitelist: (filename) =&gt; [ '.png' ].includes(path.extname(filename) || ''),</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">友情提示</p> <p>当重写了 <code>whitelist</code> 时，<code>fileExtensions</code> 不生效。</p></div> <h2 id="云存储"><a href="#云存储" aria-hidden="true" class="header-anchor">#</a> 云存储</h2> <p>当获得上传的文件之后，我们一般会转存到云存储服务，尤其是在集群的情况下。</p> <p>常用的服务有：</p> <ul><li><a href="https://cn.aliyun.com/product/oss" target="_blank" rel="noopener noreferrer">OSS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</li></ul> <h3 id="oss"><a href="#oss" aria-hidden="true" class="header-anchor">#</a> OSS</h3> <p>框架内置了 <a href="https://github.com/eggjs/egg-oss" target="_blank" rel="noopener noreferrer">egg-oss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件，默认未开启。</p> <h4 id="配置-2"><a href="#配置-2" aria-hidden="true" class="header-anchor">#</a> 配置</h4> <p>首先需要开启插件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/plugin.js</span>
exports<span class="token punctuation">.</span>oss <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后配置一下你的 <code>OSS</code> 的 <code>bucket</code>, <code>accessKeyId</code>, <code>accessKeySecret</code> 等必要信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
config<span class="token punctuation">.</span>oss <span class="token operator">=</span> <span class="token punctuation">{</span>
  client<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    accessKeyId<span class="token punctuation">:</span> <span class="token string">'your access key'</span><span class="token punctuation">,</span>
    accessKeySecret<span class="token punctuation">:</span> <span class="token string">'your access secret'</span><span class="token punctuation">,</span>
    bucket<span class="token punctuation">:</span> <span class="token string">'your bucket name'</span><span class="token punctuation">,</span>
    endpoint<span class="token punctuation">:</span> <span class="token string">'oss-cn-hongkong.aliyun.com'</span><span class="token punctuation">,</span>
    timeout<span class="token punctuation">:</span> <span class="token string">'60s'</span><span class="token punctuation">,</span>
    <span class="token comment">// accessKeyId 和 accessKeySecret 是否经过 egg-bin 加密的</span>
    <span class="token comment">// encryptPassword: false,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后通过 <code>ctx.oss.put()</code> 方法即可上传，支持 <code>File</code> 和 <code>Stream</code> 两种模式。</p> <h4 id="file-模式-2"><a href="#file-模式-2" aria-hidden="true" class="header-anchor">#</a> <code>File</code> 模式</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// file 是拿到的上传的文件对象</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> file<span class="token punctuation">.</span>filepath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// url 即为上传后的文件链接</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="stream-模式-2"><a href="#stream-模式-2" aria-hidden="true" class="header-anchor">#</a> <code>Stream</code> 模式</h4> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">UploadController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token comment">// stream 是拿到的上传的文件流对象</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span>oss<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// url 即为上传后的文件链接</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="前端直接上传-oss"><a href="#前端直接上传-oss" aria-hidden="true" class="header-anchor">#</a> 前端直接上传 OSS</h3> <p>还有一种常见的需求：前端直接上传文件到 <code>OSS</code>，不经过我们的 <code>Web</code> 应用。</p> <p>OSS 提供了 <a href="https://help.aliyun.com/document_detail/100624.html?spm=a2c4g.11186623.2.26.2a76342biQgZBM#concept-xzh-nzk-2gb" target="_blank" rel="noopener noreferrer">STS 临时授权方式<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>上述的 <code>egg-oss</code> 插件的底层是 <a href="https://github.com/ali-sdk/ali-oss" target="_blank" rel="noopener noreferrer">ali-oss<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块，也提供了对应的支持，具体参见文档。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/guide/plugin.html" class="prev">
          使用插件
        </a></span> <span class="next"><a href="/zh/guide/i18n.html">
          国际化
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.317272b7.js" defer></script><script src="/assets/js/2.7bd862e7.js" defer></script><script src="/assets/js/30.dcc0f8a4.js" defer></script>
  </body>
</html>
