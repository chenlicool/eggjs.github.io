<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Cookie | Egg</title>
    <meta name="description" content="为企业级框架和应用而生">
    
    
    <link rel="preload" href="/assets/css/0.styles.5203916d.css" as="style"><link rel="preload" href="/assets/js/app.317272b7.js" as="script"><link rel="preload" href="/assets/js/2.7bd862e7.js" as="script"><link rel="preload" href="/assets/js/17.97cab730.js" as="script"><link rel="prefetch" href="/assets/js/10.c3972b62.js"><link rel="prefetch" href="/assets/js/11.e9585f68.js"><link rel="prefetch" href="/assets/js/12.3815fe1e.js"><link rel="prefetch" href="/assets/js/13.5e06d49d.js"><link rel="prefetch" href="/assets/js/14.3b6fddd8.js"><link rel="prefetch" href="/assets/js/15.494082f6.js"><link rel="prefetch" href="/assets/js/16.b546ed30.js"><link rel="prefetch" href="/assets/js/18.bbddf561.js"><link rel="prefetch" href="/assets/js/19.1c667745.js"><link rel="prefetch" href="/assets/js/20.79b3431f.js"><link rel="prefetch" href="/assets/js/21.4be0f224.js"><link rel="prefetch" href="/assets/js/22.36f8502b.js"><link rel="prefetch" href="/assets/js/23.4a400231.js"><link rel="prefetch" href="/assets/js/24.e0d88e74.js"><link rel="prefetch" href="/assets/js/25.e176e978.js"><link rel="prefetch" href="/assets/js/26.e04f1b85.js"><link rel="prefetch" href="/assets/js/27.46820c07.js"><link rel="prefetch" href="/assets/js/28.56abde8a.js"><link rel="prefetch" href="/assets/js/29.4e4c2114.js"><link rel="prefetch" href="/assets/js/3.e44b477d.js"><link rel="prefetch" href="/assets/js/30.dcc0f8a4.js"><link rel="prefetch" href="/assets/js/31.7a987d06.js"><link rel="prefetch" href="/assets/js/32.28875310.js"><link rel="prefetch" href="/assets/js/4.d58994b3.js"><link rel="prefetch" href="/assets/js/5.10b31697.js"><link rel="prefetch" href="/assets/js/6.3a86b35b.js"><link rel="prefetch" href="/assets/js/7.bb785290.js"><link rel="prefetch" href="/assets/js/8.80b3eee6.js"><link rel="prefetch" href="/assets/js/9.3f5434be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5203916d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">Egg</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/cookie.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/guide/cookie.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/zh/guide/" class="sidebar-link">概述</a></li><li><a href="/zh/guide/directory.html" class="sidebar-link">目录规范</a></li><li><a href="/zh/guide/middleware.html" class="sidebar-link">Middleware</a></li><li><a href="/zh/guide/controller.html" class="sidebar-link">Controller</a></li><li><a href="/zh/guide/router.html" class="sidebar-link">Router</a></li><li><a href="/zh/guide/service.html" class="sidebar-link">Service</a></li><li><a href="/zh/guide/application.html" class="sidebar-link">Application</a></li><li><a href="/zh/guide/context.html" class="sidebar-link">Context</a></li><li><a href="/zh/guide/config.html" class="sidebar-link">配置</a></li><li><a href="/zh/guide/logger.html" class="sidebar-link">日志</a></li><li><a href="/zh/guide/cookie.html" class="active sidebar-link">Cookie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#使用场景" class="sidebar-link">使用场景</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#使用-cookie" class="sidebar-link">使用 Cookie</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#术语解释" class="sidebar-link">术语解释</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#api-说明" class="sidebar-link">API 说明</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#cookie-实战" class="sidebar-link">Cookie 实战</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#编写测试" class="sidebar-link">编写测试</a></li><li class="sidebar-sub-header"><a href="/zh/guide/cookie.html#注意事项" class="sidebar-link">注意事项</a></li></ul></li><li><a href="/zh/guide/session.html" class="sidebar-link">Session</a></li><li><a href="/zh/guide/helper.html" class="sidebar-link">Helper</a></li><li><a href="/zh/guide/httpclient.html" class="sidebar-link">HttpClient</a></li><li><a href="/zh/guide/error_handler.html" class="sidebar-link">异常处理</a></li><li><a href="/zh/guide/lifecycle.html" class="sidebar-link">生命周期</a></li><li><a href="/zh/guide/plugin.html" class="sidebar-link">使用插件</a></li><li><a href="/zh/guide/upload.html" class="sidebar-link">文件上传</a></li><li><a href="/zh/guide/i18n.html" class="sidebar-link">国际化</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="使用场景"><a href="#使用场景" aria-hidden="true" class="header-anchor">#</a> 使用场景</h2> <p>HTTP 请求都是无状态的，但是我们的 Web 应用通常都需要知道发起请求的人是谁。</p> <p>为了解决这个问题，HTTP 协议设计了一个特殊的请求头：<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Cookies" target="_blank" rel="noopener noreferrer">Cookie<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>服务端可以通过响应头将少量数据响应给客户端，浏览器会遵循协议将数据保存，并在下次请求同一个服务的时候带上对应的数据。</p> <p><code>Cookie</code> 主要用于：</p> <ul><li>会话状态管理（如用户登录状态、购物车、游戏分数或其它需要记录的信息）</li> <li>个性化设置（如用户自定义设置、主题等）</li> <li>浏览器行为跟踪（如跟踪分析用户行为等）</li></ul> <p>服务器使用 <code>Set-Cookie</code> 响应头部向用户浏览器发送 <code>Cookie</code> 信息：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>HTTP/1.0 200 OK
Content-type: text/html
Set-Cookie: uid=123456
Set-Cookie: user=tz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>后续对该服务发起的每一次新请求，浏览器都会将之前保存的信息通过 <code>Cookie</code> 请求头回传：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>GET /user HTTP/1.1
Host: www.example.org
Cookie: uid=123456; user=tz
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="使用-cookie"><a href="#使用-cookie" aria-hidden="true" class="header-anchor">#</a> 使用 Cookie</h2> <p>框架内置了 <a href="https://github.com/eggjs/egg-cookies" target="_blank" rel="noopener noreferrer">egg-cookies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件，提供了 <code>ctx.cookies</code>，用于便捷、安全的读写 <code>Cookie</code>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/controller/home.js</span>
<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> count <span class="token operator">=</span> ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    count <span class="token operator">=</span> count <span class="token operator">?</span> <span class="token function">Number</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token operator">++</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> count<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">async</span> <span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">204</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">友情提示</p> <p>在使用 <code>Cookie</code> 时我们需要思考清楚它的场景：</p> <ul><li>需要被浏览器保存多久？</li> <li>是否可以被 js 获取到？</li> <li>是否可以被前端修改？</li></ul></div> <p><strong>框架默认配置下， <code>Cookie</code> 是加签不加密的，浏览器可以看到明文，js 不能访问，不能被客户端（手工）篡改。</strong></p> <h2 id="术语解释"><a href="#术语解释" aria-hidden="true" class="header-anchor">#</a> 术语解释</h2> <h3 id="过期时间"><a href="#过期时间" aria-hidden="true" class="header-anchor">#</a> 过期时间</h3> <p><code>Expires</code> 和 <code>Max-Age</code> 用于定义 <code>Cookie</code> 对应的键值对的持久化时间。</p> <p><code>Expires</code> 优先级低于 <code>Max-Age</code>，如果两者都没设置，则将会在关闭浏览器时失效。</p> <h3 id="作用域"><a href="#作用域" aria-hidden="true" class="header-anchor">#</a> 作用域</h3> <p><code>Domain</code> 和 <code>Path</code> 标识定义了 <code>Cookie</code> 的作用域：即 <code>Cookie</code> 应该发送给哪些 URL。</p> <h3 id="安全"><a href="#安全" aria-hidden="true" class="header-anchor">#</a> 安全</h3> <ul><li><code>Secure</code>：<code>Cookie</code> 只有在 <code>HTTPS</code> 协议下才会发送给服务端。</li> <li><code>HttpOnly</code>：<code>Cookie</code> 将无法被 JavaScript 访问，从而避免 <a href="/zh/ecosystem/security/xss.html">XSS</a> 攻击。</li></ul> <h3 id="加签-加密"><a href="#加签-加密" aria-hidden="true" class="header-anchor">#</a> 加签 &amp;&amp; 加密</h3> <ul><li><code>加签</code>：对 <code>Cookie</code> 进行签名，避免前端篡改。不会修改原键值，而是新增一个 <code>${key}.sig</code> 的键值。</li> <li><code>加密</code>：对 <code>Cookie</code> 进行加密，避免 <code>Cookie</code> 明文写入，泄露给恶意用户。</li></ul> <h2 id="api-说明"><a href="#api-说明" aria-hidden="true" class="header-anchor">#</a> API 说明</h2> <h3 id="set-key-value-options"><a href="#set-key-value-options" aria-hidden="true" class="header-anchor">#</a> <code>set(key, value, options)</code></h3> <p>框架提供了 <code>ctx.set(key, value, options)</code> 来向用户发送 <code>Cookie</code> 信息。</p> <p>其中，<code>key</code> 和 <code>value</code> 称之为一个 <code>键值对</code>。配置参数 <code>options</code> 见<a href="#options">下文</a>。</p> <h3 id="get-key-options"><a href="#get-key-options" aria-hidden="true" class="header-anchor">#</a> <code>get(key, options)</code></h3> <p><code>Cookie</code> 是通过同一个 <code>Header</code> 中传输过来的，因此需要通过该方法解析并获取对应的值。</p> <p>值得注意的是，获取时的 <code>options.signed</code> 和 <code>options.encrypt</code> 要和 <code>set()</code> 的时候保持一致。</p> <h3 id="options"><a href="#options" aria-hidden="true" class="header-anchor">#</a> options</h3> <p>与 <a href="#%E6%9C%AF%E8%AF%AD%E8%A7%A3%E9%87%8A">术语</a> 一一对应，支持以下参数配置：</p> <ul><li><strong>maxAge</strong>:  <code>{Number}</code> 在浏览器的最长保存时间。</li> <li><strong>expires</strong>: <code>{Date}</code> 失效时间。优先级低于 <code>maxAge</code>。如果两者都没设置，则将会在关闭浏览器时失效。</li> <li><strong>path</strong>: <code>{String}</code> 生效的 URL 路径，默认为 <code>/</code>，即当前域名下均可访问这个 Cookie。</li> <li><strong>domain</strong>: <code>{String}</code> 对生效的域名，默认没有配置，可以配置成只在指定域名才能访问。</li> <li><strong>httpOnly</strong>: <code>{Boolean}</code> 是否可以被 js 访问，<strong>默认为 true，不允许被 js 访问</strong>。</li> <li><strong>secure</strong>: <code>{Boolean}</code> 框架会自动判断当前请求是否为 HTTPS，从而自动赋值。</li> <li><strong>signed</strong>: <code>{Boolean}</code>：是否加签，默认为 true。</li> <li><strong>encrypt</strong>: <code>{Boolean}</code> 是否加密，默认为 false。</li></ul> <p>此外，还扩展了：</p> <ul><li><strong>overwrite</strong> <code>{Boolean}</code>：相同的 <code>Key</code> 的处理逻辑，为 true，则后设置的值会覆盖前面设置的，否则将会发送两个 <code>Set-Cookie</code> 响应头。</li></ul> <h3 id="配置秘钥"><a href="#配置秘钥" aria-hidden="true" class="header-anchor">#</a> 配置秘钥</h3> <p>由于我们在 <code>Cookie</code> 中需要用到<code>加解密</code>和<code>验签</code>，所以需要配置一个秘钥供加密使用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  keys<span class="token punctuation">:</span> <span class="token string">'key1,key2'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果你没配置该属性，则在访问时会报错：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>ERROR 17996 <span class="token punctuation">[</span>-/::1/-/7ms GET /<span class="token punctuation">]</span> nodejs.Error: Please <span class="token keyword">set</span> config.keysfirst
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>keys</code> 配置成一个字符串，可以按照逗号分隔配置多个 key。</p> <p><code>Cookie</code> 在使用这个配置进行加解密时：</p> <ul><li><code>加密</code>和<code>加签</code>时只会使用第一个秘钥。</li> <li><code>解密</code>和<code>验签</code>时会遍历 <code>keys</code> 进行解密。</li></ul> <p>如果我们想要更新 <code>Cookie</code> 的秘钥，但是又不希望之前设置到用户浏览器上的 <code>Cookie</code> 失效，可以将新的秘钥配置到 <code>keys</code> 最前面，等过一段时间之后再删去不需要的秘钥即可。</p> <h2 id="cookie-实战"><a href="#cookie-实战" aria-hidden="true" class="header-anchor">#</a> Cookie 实战</h2> <h3 id="读取前端写入的-cookie"><a href="#读取前端写入的-cookie" aria-hidden="true" class="header-anchor">#</a> 读取前端写入的 Cookie</h3> <p>如果要获取前端或者其他系统设置的 <code>Cookie</code>，需要指定参数 <code>signed</code> 为 <code>false</code>，避免对它做验签导致获取不到 <code>Cookie</code> 的值。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'frontend-cookie'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  signed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="允许前端读取-cookie"><a href="#允许前端读取-cookie" aria-hidden="true" class="header-anchor">#</a> 允许前端读取 Cookie</h3> <p>如果想要 <code>Cookie</code> 在浏览器端可以被 js 访问并修改:</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  signed<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="不允许浏览器看到明文内容"><a href="#不允许浏览器看到明文内容" aria-hidden="true" class="header-anchor">#</a> 不允许浏览器看到明文内容</h3> <p>如果想要 <code>Cookie</code> 在浏览器端不能被修改，不能看到明文：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  httpOnly<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 默认就是 true</span>
  encrypt<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 加密传输</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="删除-cookie"><a href="#删除-cookie" aria-hidden="true" class="header-anchor">#</a> 删除 Cookie</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="编写测试"><a href="#编写测试" aria-hidden="true" class="header-anchor">#</a> 编写测试</h2> <p>类似 <a href="/zh/guide/controller.html">Controller</a> 的测试。</p> <p>需注意的是：模拟 <code>Cookies</code> 可能需要加上对应的 <code>sig</code> 加签信息。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// test/controller/cookies.test.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/controller/cookies.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should GET /'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cookies'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'cookie'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span> <span class="token string">'name=tz; path=/; httponly,name.sig=KdTywxAfCA4vHc1fmNipTZ9zPhBatn1br5tXWomvO14; path=/; httponly'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'set-cookie'</span><span class="token punctuation">,</span> <span class="token regex">/uid=123;/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>具体的单元测试运行方式，参见 <a href="/zh/workflow/development/unittest.html">研发流程 - 单元测试</a> 文档。</p> <h2 id="注意事项"><a href="#注意事项" aria-hidden="true" class="header-anchor">#</a> 注意事项</h2> <ol><li>由于<a href="http://stackoverflow.com/questions/7567154/can-i-use-unicode-characters-in-http-headers" target="_blank" rel="noopener noreferrer">浏览器和其他客户端实现的不确定性<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，为了保证 Cookie 可以写入成功，建议 value 通过 base64 编码或者其他形式 encode 之后再写入。</li> <li>由于<a href="http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key" target="_blank" rel="noopener noreferrer">浏览器对 Cookie 有长度限制限制<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，所以尽量不要设置太长的 Cookie。一般来说不要超过 4093 bytes。当设置的 Cookie value 大于这个值时，框架会打印一条警告日志。</li> <li><strong>尽可能少写入数据到 Cookie</strong>。</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/guide/logger.html" class="prev">
          日志
        </a></span> <span class="next"><a href="/zh/guide/session.html">
          Session
        </a>
        →
      </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.317272b7.js" defer></script><script src="/assets/js/2.7bd862e7.js" defer></script><script src="/assets/js/17.97cab730.js" defer></script>
  </body>
</html>
