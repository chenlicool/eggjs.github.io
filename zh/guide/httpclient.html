<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>HttpClient | Egg</title>
    <meta name="description" content="为企业级框架和应用而生">
    <link rel="icon" href="/favicon.png" type="image/x-icon">
    
    <link rel="preload" href="/assets/css/0.styles.4659e948.css" as="style"><link rel="preload" href="/assets/js/app.2e8db10c.js" as="script"><link rel="preload" href="/assets/js/3.dcc3f7c0.js" as="script"><link rel="preload" href="/assets/js/1.afc15f94.js" as="script"><link rel="preload" href="/assets/js/25.32f81bbe.js" as="script"><link rel="prefetch" href="/assets/js/10.1d10814c.js"><link rel="prefetch" href="/assets/js/11.5abde44a.js"><link rel="prefetch" href="/assets/js/12.2889c771.js"><link rel="prefetch" href="/assets/js/13.5756d463.js"><link rel="prefetch" href="/assets/js/14.76791e11.js"><link rel="prefetch" href="/assets/js/15.496a396e.js"><link rel="prefetch" href="/assets/js/16.b174f96e.js"><link rel="prefetch" href="/assets/js/17.7da596f5.js"><link rel="prefetch" href="/assets/js/18.a0b1deac.js"><link rel="prefetch" href="/assets/js/19.e65fcbf6.js"><link rel="prefetch" href="/assets/js/20.a4fb7e93.js"><link rel="prefetch" href="/assets/js/21.ff93a132.js"><link rel="prefetch" href="/assets/js/22.828a3b43.js"><link rel="prefetch" href="/assets/js/23.6397e5b9.js"><link rel="prefetch" href="/assets/js/24.9be1b01e.js"><link rel="prefetch" href="/assets/js/26.2b5d15f2.js"><link rel="prefetch" href="/assets/js/27.3f5677d2.js"><link rel="prefetch" href="/assets/js/28.29168215.js"><link rel="prefetch" href="/assets/js/29.dd5dfed9.js"><link rel="prefetch" href="/assets/js/30.b6d90030.js"><link rel="prefetch" href="/assets/js/31.1141f7ac.js"><link rel="prefetch" href="/assets/js/32.dfb8cc9e.js"><link rel="prefetch" href="/assets/js/33.0955b641.js"><link rel="prefetch" href="/assets/js/34.bdc8e075.js"><link rel="prefetch" href="/assets/js/35.eeb51878.js"><link rel="prefetch" href="/assets/js/4.3e5c2d0b.js"><link rel="prefetch" href="/assets/js/5.b83169a7.js"><link rel="prefetch" href="/assets/js/6.b736b694.js"><link rel="prefetch" href="/assets/js/7.a26c7040.js"><link rel="prefetch" href="/assets/js/8.cf9e16b0.js"><link rel="prefetch" href="/assets/js/9.7106307e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4659e948.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <div class="left-logo-part"><a href="/zh/" class="home-link router-link-active"><img src="/logo.svg" alt="Egg" class="logo"> <span class="site-name can-hide">Egg</span></a> <div placeholder="在 Egg 中搜索" class="egg-search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value="" placeholder="在 Egg 中搜索"> <!----></div></div> <div class="links"><nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item dropdown-item-single"><h4><a href="/" class="nav-link">English</a></h4> <!----></li><li class="dropdown-item dropdown-item-single"><h4><a href="/zh/guide/httpclient.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></h4> <!----></li></ul></div></div> <div class="nav-item"><a href="https://github.com/eggjs/eggjs.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></nav></div></header> <div class="sidebar-mask"></div> <aside stick="foot" class="sticker sidebar"><div class="sidebar-wrap"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link router-link-active">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item dropdown-item-single"><h4><a href="/" class="nav-link">English</a></h4> <!----></li><li class="dropdown-item dropdown-item-single"><h4><a href="/zh/guide/httpclient.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></h4> <!----></li></ul></div></div> <div class="nav-item"><a href="https://github.com/eggjs/eggjs.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
      GitHub
      <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></nav>  <ul class="sidebar-links"><li><section class="sidebar-item"><a href="/zh/guide/" class="sidebar-item-heading router-link-active"><!---->
    概述
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/directory.html" class="sidebar-item-heading"><!---->
    目录规范
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/middleware.html" class="sidebar-item-heading"><!---->
    Middleware
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/controller.html" class="sidebar-item-heading"><!---->
    Controller
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/router.html" class="sidebar-item-heading"><!---->
    Router
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/service.html" class="sidebar-item-heading"><!---->
    Service
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/application.html" class="sidebar-item-heading"><!---->
    Application
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/context.html" class="sidebar-item-heading"><!---->
    Context
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/config.html" class="sidebar-item-heading"><!---->
    配置
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/logger.html" class="sidebar-item-heading"><!---->
    日志
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/cookie.html" class="sidebar-item-heading"><!---->
    Cookie
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/session.html" class="sidebar-item-heading"><!---->
    Session
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/helper.html" class="sidebar-item-heading"><!---->
    Helper
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/httpclient.html" class="sidebar-item-heading router-link-exact-active router-link-active"><!---->
    HttpClient
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/error_handler.html" class="sidebar-item-heading"><!---->
    异常处理
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/lifecycle.html" class="sidebar-item-heading"><!---->
    生命周期
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/plugin.html" class="sidebar-item-heading"><!---->
    使用插件
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/upload.html" class="sidebar-item-heading"><!---->
    文件上传
  </a> <!----></section></li><li><section class="sidebar-item"><a href="/zh/guide/i18n.html" class="sidebar-item-heading"><!---->
    国际化
  </a> <!----></section></li></ul> </div></aside> <main class="page"> <div class="content content__default"><h1 id="httpclient"><a href="#httpclient" aria-hidden="true" class="header-anchor">#</a> HttpClient</h1> <h2 id="使用背景"><a href="#使用背景" aria-hidden="true" class="header-anchor">#</a> 使用背景</h2> <p>互联网时代，无数服务是基于 HTTP 协议进行通信的。</p> <p>在前面我们了解到的，都是 <code>Node.js</code> 作为 Web 服务端的相关知识。</p> <p>其实应用本身作为发起者，来调用后端服务也是一种非常常见的应用场景。</p> <p>譬如：</p> <ul><li>调用后端微服务，查询或更新数据。</li> <li>把日志上报给第三方服务。</li> <li>上传文件给后端服务。</li></ul> <p>因此，框架内置实现了一个 <code>HttpClient</code>，应用可以使用它来非常便捷地完成任何 HTTP 请求。</p> <h2 id="获取方式"><a href="#获取方式" aria-hidden="true" class="header-anchor">#</a> 获取方式</h2> <h3 id="app-httpclient"><a href="#app-httpclient" aria-hidden="true" class="header-anchor">#</a> <code>app.httpclient</code></h3> <p>框架在应用初始化的时候，会自动将 <a href="https://github.com/eggjs/egg/blob/master/lib/core/httpclient.js" target="_blank" rel="noopener noreferrer">HttpClient<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 初始化到 <code>app.httpclient</code>。</p> <p>它是基于 <a href="https://github.com/node-modules/urllib" target="_blank" rel="noopener noreferrer">urllib<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块的扩展。</p> <h3 id="app-curl-url-options"><a href="#app-curl-url-options" aria-hidden="true" class="header-anchor">#</a> <code>app.curl(url, options)</code></h3> <p>框架提供的语法糖，它等价于 <code>app.httpclient.request(url, options)</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://registry.npm.taobao.org/egg/latest'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span> dataType<span class="token punctuation">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="ctx-curl-url-options"><a href="#ctx-curl-url-options" aria-hidden="true" class="header-anchor">#</a> <code>ctx.curl(url, options)</code></h3> <p>框架在 <a href="/zh/guide/context.html">Context</a> 中同样提供了对应的语法糖，这将是我们最常用的方法。</p> <p>它的区别在于，会默认注入 <code>options.ctx</code>，从而在错误处理或打印 <code>Trace</code> 日志时，可以方便的获取到上游请求的相关信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// 示例：请求一个 npm 模块信息</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token string">'https://registry.npm.taobao.org/egg/latest'</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 自动解析 JSON response</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
      <span class="token comment">// 3 秒超时</span>
      timeout<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      status<span class="token punctuation">:</span> result<span class="token punctuation">.</span>status<span class="token punctuation">,</span>
      headers<span class="token punctuation">:</span> result<span class="token punctuation">.</span>headers<span class="token punctuation">,</span>
      <span class="token keyword">package</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="常用参数及响应"><a href="#常用参数及响应" aria-hidden="true" class="header-anchor">#</a> 常用参数及响应</h2> <h3 id="请求参数"><a href="#请求参数" aria-hidden="true" class="header-anchor">#</a> 请求参数</h3> <p>最常用到的 <code>Options</code> 参数如下：</p> <ul><li><code>options.method</code>：<a href="https://nodejs.org/api/http.html#http_http_methods" target="_blank" rel="noopener noreferrer">HTTP 请求方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，默认为 <code>GET</code>，全大写格式。</li> <li><code>options.data</code>：发送的请求体，会根据 <code>contentType</code> 进行不同的处理。</li> <li><code>options.contentType</code>：发送的数据格式，取值 <code>json</code>、<code>form</code>。</li> <li><code>options.dataType</code>：对响应的数据进行格式转换，取值 <code>json</code>、<code>text</code>。</li> <li><code>options.headers</code>：请求头。</li></ul> <p>完整的请求参数 <code>options</code> 说明，参见下文的 <a href="#options-%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3">options 参数详解</a> 章节。</p> <h3 id="响应数据"><a href="#响应数据" aria-hidden="true" class="header-anchor">#</a> 响应数据</h3> <ul><li><code>result.status</code>: 响应状态码，如 <code>200</code>, <code>302</code>, <code>404</code>, <code>500</code> 等等。</li> <li><code>result.headers</code>: 响应头，类似 <code>{ 'content-type': 'text/html', ... }</code>。</li> <li><code>result.data</code>: 响应 body 数据，会根据 <code>options.dataType</code> 进行相应的格式转换。</li> <li><code>result.res.timing</code>：请求各阶段的耗时统计，需传递 <code>options.timing</code> 才会采集。</li></ul> <h2 id="httpclient-实战"><a href="#httpclient-实战" aria-hidden="true" class="header-anchor">#</a> HttpClient 实战</h2> <p>以下示例，我们都使用 <a href="https://httpbin.org" target="_blank" rel="noopener noreferrer">https://httpbin.org<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供的服务来测试。</p> <h3 id="发起-get-请求"><a href="#发起-get-请求" aria-hidden="true" class="header-anchor">#</a> 发起 GET 请求</h3> <p>读取数据几乎都是使用 <code>GET</code> 请求，它是 <code>HTTP</code> 世界最常见的场景，也是最广泛的场景。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/get?foo=bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> result<span class="token punctuation">.</span>status<span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="通过-post-发送-json"><a href="#通过-post-发送-json" aria-hidden="true" class="header-anchor">#</a> 通过 POST 发送 JSON</h3> <p>微服务间通讯，<code>JSON</code> 是最常见的协议。</p> <p>譬如，创建数据的场景一般来说都会使用 <code>POST</code> 发送 <code>JSON</code> 数据。</p> <p>关键配置为：</p> <ul><li><code>method</code>： 必须配置为 <code>POST</code>。</li> <li><code>data</code>：需要传递的数据对应，Object 类型。</li> <li><code>contentType: 'json'</code>：声明以 <code>JSON</code> 格式发送，框架会自动对其 <code>stringify</code> 处理。</li> <li><code>dataType: 'json'</code>：告知框架应该自动把响应数据解析为 <code>JSON</code> 对象。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/post'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 必须指定 method</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// 通过 contentType 声明以 JSON 格式发送</span>
      contentType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        hello<span class="token punctuation">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
        now<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 明确告诉 HttpClient 以 JSON 格式处理返回的响应 body</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="提交-form-表单"><a href="#提交-form-表单" aria-hidden="true" class="header-anchor">#</a> 提交 Form 表单</h3> <p>也有很多接口是面向浏览器设计的，需要通过 <code>Form</code> 表单方式提交接口。</p> <p>只需把对应的 <code>contentType</code> 配置为 <code>form</code> 即可，框架会自动组装为对应的格式，并通过 <code>application/x-www-form-urlencoded</code> 提交。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/post'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// 通过 `form` 格式提交，application/x-www-form-urlencoded</span>
      contentType<span class="token punctuation">:</span> <span class="token string">'form'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        now<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>form<span class="token punctuation">;</span>
    <span class="token comment">// 响应最终会是类似以下的结果：</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   &quot;foo&quot;: &quot;bar&quot;,</span>
    <span class="token comment">//   &quot;now&quot;: &quot;1483864184348&quot;</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="文件上传-multipart"><a href="#文件上传-multipart" aria-hidden="true" class="header-anchor">#</a> 文件上传(<code>Multipart</code>)</h3> <p>当一个表单提交包含文件的时候，请求数据格式就必须以 <a href="http://tools.ietf.org/html/rfc2388" target="_blank" rel="noopener noreferrer">multipart/form-data<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 进行提交了。</p> <p><a href="https://github.com/node-modules/urllib" target="_blank" rel="noopener noreferrer">urllib<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 内置了 <a href="https://github.com/node-modules/formstream" target="_blank" rel="noopener noreferrer">formstream<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块来帮助我们生成可以被消费的 <code>form</code> 对象。</p> <p>关键配置为：</p> <ul><li><code>files</code>：需要上传的文件，支持多种形式：
<ul><li>单文件上传：支持直接传递：String 文件路径 / Stream 对象 / Buffer 对象。</li> <li>多文件上传：数组或 Object 格式，若为后者，则 key 为对应的 fieldName。</li></ul></li> <li><code>data</code>：将被转换为对应的 <code>form field</code>。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">upload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/post'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 单文件上传</span>
      files<span class="token punctuation">:</span> __filename<span class="token punctuation">,</span>

      <span class="token comment">// 多文件上传</span>
      <span class="token comment">// files: {</span>
      <span class="token comment">//   file1: __filename,</span>
      <span class="token comment">//   file2: fs.createReadStream(__filename),</span>
      <span class="token comment">//   file3: Buffer.from('mock file content'),</span>
      <span class="token comment">// },</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
    <span class="token comment">// 响应最终会是类似以下的结果：</span>
    <span class="token comment">// {</span>
    <span class="token comment">//   &quot;file&quot;: &quot;'use strict';\n\nconst For....&quot;</span>
    <span class="token comment">// }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="文件上传-stream"><a href="#文件上传-stream" aria-hidden="true" class="header-anchor">#</a> 文件上传(<code>Stream</code>)</h3> <p>在 <code>Node.js</code> 的世界里面，<a href="https://nodejs.org/api/stream.html" target="_blank" rel="noopener noreferrer">Stream<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 才是主流。</p> <p>如果服务端支持流式上传，最友好的方式还是直接发送 <code>Stream</code>。</p> <p><code>Stream</code> 实际会以 <code>Transfer-Encoding: chunked</code> 传输编码格式发送，这个转换是 <a href="https://nodejs.org/api/http.html" target="_blank" rel="noopener noreferrer">HTTP<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块自动实现的。</p> <p>关键配置为：</p> <ul><li><code>stream</code>：通过 <code>Stream</code> 模式发送数据。</li> <li><code>dataAsQueryString</code>：可选，需要传递额外的请求参数的场景。</li> <li><code>data</code>：可选，会被强制 <code>querystring.stringify</code> 处理之后拼接到 <code>URL</code> 的 <code>query</code> 参数上。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> FormStream <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formstream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">uploadByStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// 上传当前文件本身用于测试</span>
    <span class="token keyword">const</span> fileStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// httpbin.org 不支持 stream 模式，使用本地 stream 接口代替</span>
    <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>protocol<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">://</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>host<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/stream`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// 以 stream 模式提交</span>
      stream<span class="token punctuation">:</span> fileStream<span class="token punctuation">,</span>

      <span class="token comment">// 额外传递参数</span>
      dataAsQueryString<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token comment">// 一般来说都是 access token 之类的权限验证参数</span>
        accessToken<span class="token punctuation">:</span> <span class="token string">'some access token value'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
    <span class="token comment">// 响应最终会是类似以下的结果：</span>
    <span class="token comment">// {&quot;streamSize&quot;:574}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="发送-xml"><a href="#发送-xml" aria-hidden="true" class="header-anchor">#</a> 发送 XML</h3> <p>此时，可以用 <code>content</code> 参数代替 <code>data</code> 参数，框架会原样发送数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">xml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/xml'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      <span class="token comment">// 直接发送原始 xml 数据，不需要 HttpClient 做特殊处理</span>
      content<span class="token punctuation">:</span> <span class="token string">'&lt;xml&gt;&lt;hello&gt;world&lt;/hello&gt;&lt;/xml&gt;'</span><span class="token punctuation">,</span>
      headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="超时时间"><a href="#超时时间" aria-hidden="true" class="header-anchor">#</a> 超时时间</h3> <p>请求超时时间，默认是 <code>[ 5000, 5000 ]</code>，即创建连接超时是 5 秒，接收响应超时是 5 秒。</p> <p>支持 <code>Number</code> 和 <code>[ Number, Number ]</code> 格式，前者代表两个时间取同个值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">timeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/timeout'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建连接超时 1 秒，接收响应超时 30 秒，用于响应比较大的场景</span>
      timeout<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">30000</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="处理重定向"><a href="#处理重定向" aria-hidden="true" class="header-anchor">#</a> 处理重定向</h3> <p>有些时候，需要对后端的重定向进行跟进处理，框架提供了：</p> <ul><li><code>followRedirect</code>：是否自动跟进 3xx 的跳转响应，默认是 <code>false</code>。</li> <li><code>maxRedirects</code>：最大自动跳转次数，避免死循环，默认是 10 次。 此参数不宜设置过大。</li> <li><code>formatRedirectUrl(from, to)</code>：跳转 URL 校正，默认是 <code>url.resolve(from, to)</code>。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">followRedirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span><span class="token string">'/your_redirect_url'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">formatRedirectUrl</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">from</span><span class="token punctuation">,</span> to</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 允许跟踪跳转</span>
        followRedirect<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

        <span class="token comment">// 最大只允许自动跳转 5 次。</span>
        maxRedirects<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>

        <span class="token comment">// 例如可在这里修正跳转不正确的 url</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">===</span> <span class="token string">'//foo/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          to <span class="token operator">=</span> <span class="token string">'/foo'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> url<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="抓包调试"><a href="#抓包调试" aria-hidden="true" class="header-anchor">#</a> 抓包调试</h3> <p>有些时候，我们需要抓包来调试对应的 <code>HTTP</code> 请求。</p> <p>修改本地开发配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.local.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// add http_proxy to httpclient</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>http_proxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    config<span class="token punctuation">.</span>httpclient <span class="token operator">=</span> <span class="token punctuation">{</span>
      request<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        enableProxy<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        rejectUnauthorized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        proxy<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>http_proxy<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> config<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用环境变量启动你的应用：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ http_proxy<span class="token operator">=</span>http://127.0.0.1:8888 <span class="token function">npm</span> run dev
</code></pre></div><p>然后启动你的抓包工具，如 <a href="https://www.charlesproxy.com/" target="_blank" rel="noopener noreferrer">Charles<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或 <a href="http://www.telerik.com/fiddler" target="_blank" rel="noopener noreferrer">Fiddler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，就可以看到对应的 <code>HTTP</code> 抓包信息。</p> <h3 id="事件监听"><a href="#事件监听" aria-hidden="true" class="header-anchor">#</a> 事件监听</h3> <p>在企业应用场景，常常会有统一 <code>Tracer</code> 日志的需求。</p> <p>为了方便在统一监听 <code>HttpClient</code> 的请求和响应，我们约定了两个事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 对请求做拦截，设置一些 trace headers，方便全链路跟踪。</span>
app<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token parameter">req</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> requestId<span class="token punctuation">,</span> url<span class="token punctuation">,</span> args<span class="token punctuation">,</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 仅在 `ctx.curl()` 时才有值，方便记录上游请求信息。</span>

  <span class="token comment">// 例如我们可以设置全局请求 ID，方便日志跟踪</span>
  req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-request-id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">v1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 开启 timing 统计</span>
  req<span class="token punctuation">.</span>args<span class="token punctuation">.</span>timing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅事件来打印日志</span>
app<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'response'</span><span class="token punctuation">,</span> <span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> requestId<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> error <span class="token punctuation">}</span> <span class="token operator">=</span> result<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> res<span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>res<span class="token punctuation">.</span>timing<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 统计请求各阶段的耗时</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 仅在 `ctx.curl()` 时才有值，方便记录上游请求信息。</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="如何扩展"><a href="#如何扩展" aria-hidden="true" class="header-anchor">#</a> 如何扩展</h2> <p>我们跟后端的接口协议，往往会在 <code>HTTP</code> 上做一层简单的协议封装，如加解密和校验。</p> <p>如果每次调用 <code>HttpClient</code> 的时候，都要传递参数和解析协议，未免太麻烦。</p> <p>此时可以扩展下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// app/extend/context.js</span>
<span class="token keyword">const</span> rpc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../../lib/rpc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">rpc</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提供请求的默认值</span>
    options <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
      dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
      contentType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发起 HTTP 请求</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 对后端返回结果进行预处理，如校验、解密等。</span>
    result <span class="token operator">=</span> rpc<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样，在 <code>Controller</code>、<code>Service</code> 等地方就可以直接使用了：</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// app/controller/http.js</span>
<span class="token keyword">class</span> <span class="token class-name">HttpController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// 调用对应的扩展方法</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">rpc</span><span class="token punctuation">(</span><span class="token string">'https://httpbin.org/post'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        hello<span class="token punctuation">:</span> <span class="token string">'world'</span><span class="token punctuation">,</span>
        now<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="编写测试"><a href="#编写测试" aria-hidden="true" class="header-anchor">#</a> 编写测试</h2> <p>对于 <code>HttpClient</code> 这种关键的请求交互，单元测试就更必不可少。</p> <p>框架通过 <a href="https://github.com/eggjs/egg-mock" target="_blank" rel="noopener noreferrer">egg-mock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 提供了 <code>app.mockHttpclient(url, method, data)</code> 的模拟能力。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'GET /httpclient'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should mock httpclient response'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span><span class="token function">mockHttpclient</span><span class="token punctuation">(</span><span class="token string">'https://eggjs.org'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// 模拟的参数，可以是 `Buffer/String/JSON`</span>
      <span class="token comment">// 会按照请求时的 `options.dataType` 来做对应的转换</span>
      data<span class="token punctuation">:</span> <span class="token string">'mock eggjs.org response'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/httpclient'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'mock eggjs.org response'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>详见对应的 <a href="https://github.com/eggjs/egg-mock#appmockhttpclienturl-method-data" target="_blank" rel="noopener noreferrer">Mock API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>具体的单元测试运行方式，参见 <a href="/zh/workflow/development/unittest.html">研发流程 - 单元测试</a> 文档。</p> <h2 id="常见错误码"><a href="#常见错误码" aria-hidden="true" class="header-anchor">#</a> 常见错误码</h2> <h3 id="connectiontimeouterror"><a href="#connectiontimeouterror" aria-hidden="true" class="header-anchor">#</a> <code>ConnectionTimeoutError</code></h3> <ul><li>异常名称：<strong>创建连接超时</strong>，<code>ConnectionTimeoutError</code></li> <li>出现场景：通常是 DNS 查询比较慢，或者客户端与服务端之间的网络速度比较慢导致的。</li> <li>排查建议：请适当增大 <code>timeout</code> 参数。</li></ul> <h3 id="responsetimeouterror"><a href="#responsetimeouterror" aria-hidden="true" class="header-anchor">#</a> <code>ResponseTimeoutError</code></h3> <ul><li>异常名称：<strong>服务响应超时</strong>，<code>ResponseTimeoutError</code></li> <li>出现场景：通常是客户端与服务端之间网络速度比较慢，并且响应数据比较大的情况下会发生。</li> <li>排查建议：请适当增大 <code>timeout</code> 参数。</li></ul> <h3 id="econnreset"><a href="#econnreset" aria-hidden="true" class="header-anchor">#</a> <code>ECONNRESET</code></h3> <ul><li>异常名称：<strong>服务主动断开连接</strong>，<code>ResponseError, code: ECONNRESET</code></li> <li>出现场景：通常是服务端主动断开 Socket 连接，导致 HTTP 请求链路异常。</li> <li>排查建议：请检查当时服务端是否发生网络异常。</li></ul> <h3 id="econnrefused"><a href="#econnrefused" aria-hidden="true" class="header-anchor">#</a> <code>ECONNREFUSED</code></h3> <ul><li>异常名称：<strong>服务不可达</strong>，<code>RequestError, code: ECONNREFUSED, status: -1</code></li> <li>出现场景：通常是因为请求的 URL 所属 IP 或者端口无法连接成功。</li> <li>排查建议：请确保 IP 或者端口设置正确，目标网络是通的。</li></ul> <h3 id="enotfound"><a href="#enotfound" aria-hidden="true" class="header-anchor">#</a> <code>ENOTFOUND</code></h3> <ul><li>异常名称：<strong>域名不存在</strong>，<code>RequestError, code: ENOTFOUND, status: -1</code></li> <li>出现场景：通常是因为请求的 URL 所在的域名无法通过 DNS 解析成功。</li> <li>排查建议：请确保域名存在，也需要排查一下 DNS 服务是否配置正确。</li></ul> <h3 id="jsonresponseformaterror"><a href="#jsonresponseformaterror" aria-hidden="true" class="header-anchor">#</a> <code>JSONResponseFormatError</code></h3> <ul><li>异常名称：<strong>JSON 响应数据解析失败</strong>，<code>JSONResponseFormatError</code></li> <li>出现场景：设置了 <code>dataType=json</code>，但响应数据不符合 JSON 格式，就会抛出此异常。</li> <li>排查建议：确保服务端无论在什么情况下都要正确返回 JSON 格式的数据。</li></ul> <p>有些 CGI 系统返回的 JSON 数据会包含某些特殊控制字符(U+0000 ~ U+001F)，可以通过 <code>fixJSONCtlChars</code> 参数自动过滤掉它们。</p> <h2 id="options-参数详解"><a href="#options-参数详解" aria-hidden="true" class="header-anchor">#</a> Options 参数详解</h2> <p>由于 HTTP 请求的复杂性，导致 <code>HttpClient</code> 的 <code>options</code> 参数会非常多。</p> <p>接下来讲解常用的可选参数的实际用途，更多的参数可以参见 <a href="https://github.com/node-modules/urllib" target="_blank" rel="noopener noreferrer">urllib<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <h3 id="默认全局配置"><a href="#默认全局配置" aria-hidden="true" class="header-anchor">#</a> 默认全局配置</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
exports<span class="token punctuation">.</span>httpclient <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 是否开启本地 DNS 缓存，默认关闭，开启后有两个特性</span>
  <span class="token comment">// 1. 所有的 DNS 查询都会默认优先使用缓存的，即使 DNS 查询错误也不影响应用</span>
  <span class="token comment">// 2. 对同一个域名，在 dnsCacheLookupInterval 的间隔内（默认 10s）只会查询一次</span>
  enableDNSCache<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token comment">// 对同一个域名进行 DNS 查询的最小间隔时间</span>
  dnsCacheLookupInterval<span class="token punctuation">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
  <span class="token comment">// DNS 同时缓存的最大域名数量，默认 1000</span>
  dnsCacheMaxLength<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>

  request<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认 request 超时时间</span>
    timeout<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  httpAgent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认开启 http KeepAlive 功能</span>
    keepAlive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 空闲的 KeepAlive socket 最长可以存活 4 秒</span>
    freeSocketTimeout<span class="token punctuation">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
    <span class="token comment">// 当 socket 超过 30 秒都没有任何活动，就会被当作超时处理掉</span>
    timeout<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    <span class="token comment">// 允许创建的最大 socket 数</span>
    maxSockets<span class="token punctuation">:</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span><span class="token punctuation">,</span>
    <span class="token comment">// 最大空闲 socket 数</span>
    maxFreeSockets<span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  httpsAgent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 默认开启 https KeepAlive 功能</span>
    keepAlive<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">// 空闲的 KeepAlive socket 最长可以存活 4 秒</span>
    freeSocketTimeout<span class="token punctuation">:</span> <span class="token number">4000</span><span class="token punctuation">,</span>
    <span class="token comment">// 当 socket 超过 30 秒都没有任何活动，就会被当作超时处理掉</span>
    timeout<span class="token punctuation">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    <span class="token comment">// 允许创建的最大 socket 数</span>
    maxSockets<span class="token punctuation">:</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_SAFE_INTEGER</span><span class="token punctuation">,</span>
    <span class="token comment">// 最大空闲 socket 数</span>
    maxFreeSockets<span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>应用可以通过 <code>config/config.default.js</code> 覆盖此配置。</p> <h3 id="method-string"><a href="#method-string" aria-hidden="true" class="header-anchor">#</a> <code>method: String</code></h3> <p><code>HTTP</code> 请求方法，默认是 <code>GET</code>，全大写格式，支持<a href="https://nodejs.org/api/http.html#http_http_methods" target="_blank" rel="noopener noreferrer">所有 HTTP 方法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <h3 id="data-object"><a href="#data-object" aria-hidden="true" class="header-anchor">#</a> <code>data: Object</code></h3> <p>需要发送的请求数据，会根据 <code>method</code> 自动选择正确的数据处理方式。</p> <ul><li><code>GET</code>，<code>HEAD</code>：通过 <code>querystring.stringify(data)</code> 处理后拼接到 <code>URL</code> 的查询参数上。</li> <li><code>POST</code>，<code>PUT</code> 和 <code>DELETE</code> 等：需要根据 <code>contentType</code> 做进一步判断处理。
<ul><li><code>contentType = json</code>：通过 <code>JSON.stringify(data)</code> 处理，并通过请求 body 发送。</li> <li>其他：通过 <code>querystring.stringify(data)</code> 处理，并通过请求 body 发送。</li></ul></li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// GET + Query, `/api/user?foo=bar`</span>
ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// POST + Form + body</span>
ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// POST + JSON + body</span>
ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  contentType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span> foo<span class="token punctuation">:</span> <span class="token string">'bar'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="contenttype-string"><a href="#contenttype-string" aria-hidden="true" class="header-anchor">#</a> <code>contentType: String</code></h3> <p>设置请求数据格式，支持 <code>json</code> 和 <code>form</code>，决定了请求数据的序列化格式。</p> <p>如需要以 JSON 格式发送 <code>data</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    foo<span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
    now<span class="token punctuation">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  contentType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="datatype-string"><a href="#datatype-string" aria-hidden="true" class="header-anchor">#</a> <code>dataType: String</code></h3> <p>设置响应数据格式，默认不对响应数据做任何处理，直接返回原始的 buffer 格式数据。</p> <p>支持 <code>text</code> 和 <code>json</code> 两种取值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jsonResult <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  dataType<span class="token punctuation">:</span> <span class="token string">'json'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jsonResult<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> htmlResult <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  dataType<span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>htmlResult<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <p>设置成 <code>json</code> 时，如果响应数据解析失败会抛 <code>JSONResponseFormatError</code> 异常。</p></div> <h3 id="dataasquerystring-boolean"><a href="#dataasquerystring-boolean" aria-hidden="true" class="header-anchor">#</a> <code>dataAsQueryString: Boolean</code></h3> <p>如果设置为 <code>true</code>，那么即使在 POST 情况下，也会强制将 <code>options.data</code> 以 <code>querystring.stringify</code> 处理之后拼接到 <code>URL</code> 的查询参数上。</p> <p>可以很好地解决以 <code>stream</code> 发送数据，且额外的请求参数以 <code>URL Query</code> 形式传递的应用场景：</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  dataAsQueryString<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一般来说都是 access token 之类的权限验证参数</span>
    accessToken<span class="token punctuation">:</span> <span class="token string">'some access token value'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  stream<span class="token punctuation">:</span> myFileStream<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="content-string-buffer"><a href="#content-string-buffer" aria-hidden="true" class="header-anchor">#</a> <code>content: String|Buffer</code></h3> <p>发送请求正文，如果设置了此参数，那么会直接忽略 <code>data</code> 参数。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  <span class="token comment">// 直接发送原始 xml 数据，不需要 HttpClient 做特殊处理</span>
  content<span class="token punctuation">:</span> <span class="token string">'&lt;xml&gt;&lt;hello&gt;world&lt;/hello&gt;&lt;/xml&gt;'</span><span class="token punctuation">,</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'content-type'</span><span class="token punctuation">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="headers-object"><a href="#headers-object" aria-hidden="true" class="header-anchor">#</a> <code>headers: Object</code></h3> <p>自定义请求头。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'x-foo'</span><span class="token punctuation">:</span> <span class="token string">'bar'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="timeout-number-array"><a href="#timeout-number-array" aria-hidden="true" class="header-anchor">#</a> <code>timeout: Number|Array</code></h3> <p>请求超时时间，默认是 <code>[ 5000, 5000 ]</code>，即创建连接超时是 5 秒，接收响应超时是 5 秒。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建连接超时 3 秒，接收响应超时 3 秒</span>
  timeout<span class="token punctuation">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建连接超时 1 秒，接收响应超时 30 秒，用于响应比较大的场景</span>
  timeout<span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">30000</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="files-mixed"><a href="#files-mixed" aria-hidden="true" class="header-anchor">#</a> <code>files: Mixed</code></h3> <p>文件上传，支持格式： <code>String | ReadStream | Buffer | Array | Object</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  files<span class="token punctuation">:</span> <span class="token string">'/path/to/read'</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    foo<span class="token punctuation">:</span> <span class="token string">'other fields'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>多文件上传：</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  files<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    file1<span class="token punctuation">:</span> <span class="token string">'/path/to/read'</span><span class="token punctuation">,</span>
    file2<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>__filename<span class="token punctuation">)</span><span class="token punctuation">,</span>
    file3<span class="token punctuation">:</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'mock file content'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    foo<span class="token punctuation">:</span> <span class="token string">'other fields'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="stream-readstream"><a href="#stream-readstream" aria-hidden="true" class="header-anchor">#</a> <code>stream: ReadStream</code></h3> <p>设置发送请求正文的可读数据流，一旦设置了此参数，将会忽略 <code>data</code> 和 <code>content</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  method<span class="token punctuation">:</span> <span class="token string">'POST'</span><span class="token punctuation">,</span>
  stream<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'/path/to/read'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="writestream-writestream"><a href="#writestream-writestream" aria-hidden="true" class="header-anchor">#</a> <code>writeStream: WriteStream</code></h3> <p>设置接受响应数据的可写数据流，默认是 <code>null</code>。
一旦设置此参数，那么返回值 <code>result.data</code> 将会被设置为 <code>null</code>，
因为数据已经全部写入到 <code>writeStream</code> 中了。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  writeStream<span class="token punctuation">:</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span><span class="token string">'/path/to/store'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意事项</p> <p>请在你充分理解 <code>Stream</code> 和 <code>异步编程</code> 的基础上，再使用。</p></div> <h3 id="streaming-boolean"><a href="#streaming-boolean" aria-hidden="true" class="header-anchor">#</a> <code>streaming: Boolean</code></h3> <p>是否直接返回响应流。</p> <p>开启后会在拿到响应对象 <code>res</code> 时马上返回，此时 <code>headers</code> 和 <code>status</code> 已经可以读取到，但还没有读取 <code>data</code> 数据。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  streaming<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>status<span class="token punctuation">,</span> result<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// result.res 是一个 ReadStream 对象</span>
ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">.</span>res<span class="token punctuation">;</span>
</code></pre></div><div class="warning custom-block"><p class="custom-block-title">注意</p> <p>若 res 不是直接传递给 body，那么我们必须消费这个 stream，并且要做好 error 事件处理。</p></div> <h3 id="beforerequest-function-options"><a href="#beforerequest-function-options" aria-hidden="true" class="header-anchor">#</a> <code>beforeRequest: Function(options)</code></h3> <p>在请求正式发送之前，会尝试调用 <code>beforeRequest</code> 钩子，允许我们在这里对请求参数做最后一次修改。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">beforeRequest</span><span class="token punctuation">:</span> <span class="token parameter">options</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 例如我们可以设置全局请求 id，方便日志跟踪</span>
    options<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'x-request-id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> uuid<span class="token punctuation">.</span><span class="token function">v1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="gzip-boolean"><a href="#gzip-boolean" aria-hidden="true" class="header-anchor">#</a> <code>gzip: Boolean</code></h3> <p>是否支持 <code>gzip</code> 响应格式，开启后将自动设置 <code>Accept-Encoding: gzip</code> 请求头，
并且会自动解压带 <code>Content-Encoding: gzip</code> 响应头的数据。</p> <div class="language-js extra-class"><pre class="language-js"><code>ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  gzip<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="timing-boolean"><a href="#timing-boolean" aria-hidden="true" class="header-anchor">#</a> <code>timing: Boolean</code></h3> <p>是否开启请求各阶段的时间测量。</p> <p>开启后可以通过 <code>result.res.timing</code> 拿到这次 HTTP 请求各阶段的时间测量值（单位是毫秒）。</p> <p>通过这些测量值，我们可以非常方便地定位到这次请求最慢的环境发生在那个阶段，效果如同 <code>Chrome Network Timing</code> 的作用。</p> <p>各阶段测量值：</p> <ul><li><code>queuing</code>：分配 <code>Socket</code> 耗时。</li> <li><code>dnslookup</code>：<code>DNS</code> 查询耗时。</li> <li><code>connected</code>：<code>Socket</code> 三次握手连接成功耗时。</li> <li><code>requestSent</code>：请求数据完整发送完毕耗时。</li> <li><code>waiting</code>：收到第一个字节的响应数据耗时。</li> <li><code>contentDownload</code>：全部响应数据接收完毕耗时。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">curl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  timing<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>res<span class="token punctuation">.</span>timing<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {</span>
<span class="token comment">//   &quot;queuing&quot;:29,</span>
<span class="token comment">//   &quot;dnslookup&quot;:37,</span>
<span class="token comment">//   &quot;connected&quot;:370,</span>
<span class="token comment">//   &quot;requestSent&quot;:1001,</span>
<span class="token comment">//   &quot;waiting&quot;:1833,</span>
<span class="token comment">//   &quot;contentDownload&quot;:3416</span>
<span class="token comment">// }</span>
</code></pre></div><h3 id="https-相关参数"><a href="#https-相关参数" aria-hidden="true" class="header-anchor">#</a> HTTPS 相关参数</h3> <p>包括 <code>key</code>、<code>cert</code>、<code>passphrase</code> 等参数，都将透传给 <a href="https://nodejs.org/api/https.html" target="_blank" rel="noopener noreferrer">HTTPS<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 模块。</p> <p>其中 <code>rejectUnauthorized</code> 用于在本地调试时忽略无效的 HTTPS 证书。</p> <p>具体请查看 <a href="https://nodejs.org/api/https.html#https_https_request_options_callback" target="_blank" rel="noopener noreferrer"><code>https.request()</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 文档。</p> <h2 id="示例代码"><a href="#示例代码" aria-hidden="true" class="header-anchor">#</a> 示例代码</h2> <p>完整示例代码可以在 <a href="https://github.com/eggjs/examples/blob/master/httpclient" target="_blank" rel="noopener noreferrer">eggjs/examples/httpclient<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 找到。</p></div> <footer class="page-edit"><!----> <div class="edit-link"><a href="https://github.com/eggjs/eggjs.github.io/blob/docs/docs/zh/guide/httpclient.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div></footer> <div class="page-nav"><p class="inner"><a href="/zh/guide/helper.html" title="Helper" class="prev">
        上一篇<br><span>Helper</span></a> <a href="/zh/guide/error_handler.html" title="异常处理" class="next">
        下一篇<br><span>异常处理</span></a></p></div> </main> <div class="global-foot"><div class="friend-links"><div class="friend-list-wrapper"><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Github</div> <a href="https://github.com/eggjs" target="_blank" class="friend-list-item">Organization</a><a href="https://github.com/eggjs/examples" target="_blank" class="friend-list-item">Example</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Links</div> <a href="https://ant.design" target="_blank" class="friend-list-item">Ant Design</a><a href="http://motion.ant.design/" target="_blank" class="friend-list-item">Ant Motion</a><a href="https://antv.alipay.com/" target="_blank" class="friend-list-item">Antv</a><a href="https://umijs.org/" target="_blank" class="friend-list-item">Umi.js</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Community</div> <a href="https://eggjs.org/zh-cn/faq.html" target="_blank" class="friend-list-item">FAQ</a><a href="https://www.yuque.com/egg/nodejs" target="_blank" class="friend-list-item">Node.js Column</a> <!----></div></div><div class="friend-list"><div class="friend-list-align"><div class="friend-list-title">Egg.js Dingtalk</div>  <div class="friend-qrcode"><img src="/img_egg/qrcode_dingtalk.png"></div></div></div></div></div> <div class="copyright"><span class="span"><span>Copyright © 2019 Egg.js</span></span></div></div> <div stick="foot" class="sticker egg-toc"><div class="egg-toc-item egg-toc-h2 active"><a href="#使用背景" title="使用背景">使用背景</a></div><div class="egg-toc-item egg-toc-h2"><a href="#获取方式" title="获取方式">获取方式</a></div><div class="egg-toc-item egg-toc-h3"><a href="#app-httpclient" title="app.httpclient">app.httpclient</a></div><div class="egg-toc-item egg-toc-h3"><a href="#app-curl-url-options" title="app.curl(url, options)">app.curl(url, options)</a></div><div class="egg-toc-item egg-toc-h3"><a href="#ctx-curl-url-options" title="ctx.curl(url, options)">ctx.curl(url, options)</a></div><div class="egg-toc-item egg-toc-h2"><a href="#常用参数及响应" title="常用参数及响应">常用参数及响应</a></div><div class="egg-toc-item egg-toc-h3"><a href="#请求参数" title="请求参数">请求参数</a></div><div class="egg-toc-item egg-toc-h3"><a href="#响应数据" title="响应数据">响应数据</a></div><div class="egg-toc-item egg-toc-h2"><a href="#httpclient-实战" title="HttpClient 实战">HttpClient 实战</a></div><div class="egg-toc-item egg-toc-h3"><a href="#发起-get-请求" title="发起 GET 请求">发起 GET 请求</a></div><div class="egg-toc-item egg-toc-h3"><a href="#通过-post-发送-json" title="通过 POST 发送 JSON">通过 POST 发送 JSON</a></div><div class="egg-toc-item egg-toc-h3"><a href="#提交-form-表单" title="提交 Form 表单">提交 Form 表单</a></div><div class="egg-toc-item egg-toc-h3"><a href="#文件上传-multipart" title="文件上传(Multipart)">文件上传(Multipart)</a></div><div class="egg-toc-item egg-toc-h3"><a href="#文件上传-stream" title="文件上传(Stream)">文件上传(Stream)</a></div><div class="egg-toc-item egg-toc-h3"><a href="#发送-xml" title="发送 XML">发送 XML</a></div><div class="egg-toc-item egg-toc-h3"><a href="#超时时间" title="超时时间">超时时间</a></div><div class="egg-toc-item egg-toc-h3"><a href="#处理重定向" title="处理重定向">处理重定向</a></div><div class="egg-toc-item egg-toc-h3"><a href="#抓包调试" title="抓包调试">抓包调试</a></div><div class="egg-toc-item egg-toc-h3"><a href="#事件监听" title="事件监听">事件监听</a></div><div class="egg-toc-item egg-toc-h2"><a href="#如何扩展" title="如何扩展">如何扩展</a></div><div class="egg-toc-item egg-toc-h2"><a href="#编写测试" title="编写测试">编写测试</a></div><div class="egg-toc-item egg-toc-h2"><a href="#常见错误码" title="常见错误码">常见错误码</a></div><div class="egg-toc-item egg-toc-h3"><a href="#connectiontimeouterror" title="ConnectionTimeoutError">ConnectionTimeoutError</a></div><div class="egg-toc-item egg-toc-h3"><a href="#responsetimeouterror" title="ResponseTimeoutError">ResponseTimeoutError</a></div><div class="egg-toc-item egg-toc-h3"><a href="#econnreset" title="ECONNRESET">ECONNRESET</a></div><div class="egg-toc-item egg-toc-h3"><a href="#econnrefused" title="ECONNREFUSED">ECONNREFUSED</a></div><div class="egg-toc-item egg-toc-h3"><a href="#enotfound" title="ENOTFOUND">ENOTFOUND</a></div><div class="egg-toc-item egg-toc-h3"><a href="#jsonresponseformaterror" title="JSONResponseFormatError">JSONResponseFormatError</a></div><div class="egg-toc-item egg-toc-h2"><a href="#options-参数详解" title="Options 参数详解">Options 参数详解</a></div><div class="egg-toc-item egg-toc-h3"><a href="#默认全局配置" title="默认全局配置">默认全局配置</a></div><div class="egg-toc-item egg-toc-h3"><a href="#method-string" title="method: String">method: String</a></div><div class="egg-toc-item egg-toc-h3"><a href="#data-object" title="data: Object">data: Object</a></div><div class="egg-toc-item egg-toc-h3"><a href="#contenttype-string" title="contentType: String">contentType: String</a></div><div class="egg-toc-item egg-toc-h3"><a href="#datatype-string" title="dataType: String">dataType: String</a></div><div class="egg-toc-item egg-toc-h3"><a href="#dataasquerystring-boolean" title="dataAsQueryString: Boolean">dataAsQueryString: Boolean</a></div><div class="egg-toc-item egg-toc-h3"><a href="#content-string-buffer" title="content: String|Buffer">content: String|Buffer</a></div><div class="egg-toc-item egg-toc-h3"><a href="#headers-object" title="headers: Object">headers: Object</a></div><div class="egg-toc-item egg-toc-h3"><a href="#timeout-number-array" title="timeout: Number|Array">timeout: Number|Array</a></div><div class="egg-toc-item egg-toc-h3"><a href="#files-mixed" title="files: Mixed">files: Mixed</a></div><div class="egg-toc-item egg-toc-h3"><a href="#stream-readstream" title="stream: ReadStream">stream: ReadStream</a></div><div class="egg-toc-item egg-toc-h3"><a href="#writestream-writestream" title="writeStream: WriteStream">writeStream: WriteStream</a></div><div class="egg-toc-item egg-toc-h3"><a href="#streaming-boolean" title="streaming: Boolean">streaming: Boolean</a></div><div class="egg-toc-item egg-toc-h3"><a href="#beforerequest-function-options" title="beforeRequest: Function(options)">beforeRequest: Function(options)</a></div><div class="egg-toc-item egg-toc-h3"><a href="#gzip-boolean" title="gzip: Boolean">gzip: Boolean</a></div><div class="egg-toc-item egg-toc-h3"><a href="#timing-boolean" title="timing: Boolean">timing: Boolean</a></div><div class="egg-toc-item egg-toc-h3"><a href="#https-相关参数" title="HTTPS 相关参数">HTTPS 相关参数</a></div><div class="egg-toc-item egg-toc-h2"><a href="#示例代码" title="示例代码">示例代码</a></div></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2e8db10c.js" defer></script><script src="/assets/js/3.dcc3f7c0.js" defer></script><script src="/assets/js/1.afc15f94.js" defer></script><script src="/assets/js/25.32f81bbe.js" defer></script>
  </body>
</html>
