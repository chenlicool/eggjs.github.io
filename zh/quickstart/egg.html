<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>简单的 Egg 应用 | Egg</title>
    <meta name="description" content="为企业级框架和应用而生">
    
    
    <link rel="preload" href="/assets/css/0.styles.5203916d.css" as="style"><link rel="preload" href="/assets/js/app.317272b7.js" as="script"><link rel="preload" href="/assets/js/2.7bd862e7.js" as="script"><link rel="preload" href="/assets/js/5.10b31697.js" as="script"><link rel="prefetch" href="/assets/js/10.c3972b62.js"><link rel="prefetch" href="/assets/js/11.e9585f68.js"><link rel="prefetch" href="/assets/js/12.3815fe1e.js"><link rel="prefetch" href="/assets/js/13.5e06d49d.js"><link rel="prefetch" href="/assets/js/14.3b6fddd8.js"><link rel="prefetch" href="/assets/js/15.494082f6.js"><link rel="prefetch" href="/assets/js/16.b546ed30.js"><link rel="prefetch" href="/assets/js/17.97cab730.js"><link rel="prefetch" href="/assets/js/18.bbddf561.js"><link rel="prefetch" href="/assets/js/19.1c667745.js"><link rel="prefetch" href="/assets/js/20.79b3431f.js"><link rel="prefetch" href="/assets/js/21.4be0f224.js"><link rel="prefetch" href="/assets/js/22.36f8502b.js"><link rel="prefetch" href="/assets/js/23.4a400231.js"><link rel="prefetch" href="/assets/js/24.e0d88e74.js"><link rel="prefetch" href="/assets/js/25.e176e978.js"><link rel="prefetch" href="/assets/js/26.e04f1b85.js"><link rel="prefetch" href="/assets/js/27.46820c07.js"><link rel="prefetch" href="/assets/js/28.56abde8a.js"><link rel="prefetch" href="/assets/js/29.4e4c2114.js"><link rel="prefetch" href="/assets/js/3.e44b477d.js"><link rel="prefetch" href="/assets/js/30.dcc0f8a4.js"><link rel="prefetch" href="/assets/js/31.7a987d06.js"><link rel="prefetch" href="/assets/js/32.28875310.js"><link rel="prefetch" href="/assets/js/4.d58994b3.js"><link rel="prefetch" href="/assets/js/6.3a86b35b.js"><link rel="prefetch" href="/assets/js/7.bb785290.js"><link rel="prefetch" href="/assets/js/8.80b3eee6.js"><link rel="prefetch" href="/assets/js/9.3f5434be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5203916d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><!----> <span class="site-name">Egg</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link router-link-active">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/quickstart/egg.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/quickstart/egg.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/" class="nav-link">首页</a></div><div class="nav-item"><a href="/zh/quickstart/" class="nav-link router-link-active">快速开始</a></div><div class="nav-item"><a href="/zh/guide/" class="nav-link">教程</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/quickstart/egg.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/quickstart/egg.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/zh/quickstart/" class="sidebar-link">快速开始</a></li><li><a href="/zh/quickstart/egg.html" class="active sidebar-link">简单的 Egg 应用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/quickstart/egg.html#典型场景" class="sidebar-link">典型场景</a></li><li class="sidebar-sub-header"><a href="/zh/quickstart/egg.html#逐步搭建" class="sidebar-link">逐步搭建</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>在本章中我们先来学习如何写一个简单的 <code>Egg</code> 应用，通过它来了解一些基本的概念和术语。</p> <div class="tip custom-block"><p class="custom-block-title">友情提示</p> <p>需注意的是，本文介绍的是 <code>Egg</code> 的基础使用。
对于 <code>Egg</code> 的开发者而言，很多插件无需自行安装，已经内置到框架，直接开启即可。
更多内容，在<a href="/zh/guide/">开发指南</a>中可以了解到。</p></div> <h2 id="典型场景"><a href="#典型场景" aria-hidden="true" class="header-anchor">#</a> 典型场景</h2> <p>我们以 <a href="http://todomvc.com/" target="_blank" rel="noopener noreferrer">TodoMVC<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 这个典型的前端应用场景为例，一步步从零开始搭建。</p> <p>完整的源码参见 <a href="https://github.com/eggjs/examples/tree/master/todomvc" target="_blank" rel="noopener noreferrer">eggjs/examples/todomvc<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p><img src="/assets/img/todomvc.c40dbbd3.png" alt=""></p> <h2 id="逐步搭建"><a href="#逐步搭建" aria-hidden="true" class="header-anchor">#</a> 逐步搭建</h2> <h3 id="环境准备"><a href="#环境准备" aria-hidden="true" class="header-anchor">#</a> 环境准备</h3> <ul><li>操作系统：支持 <code>macOS</code>，<code>Linux</code>，<code>Windows</code>，推荐本地开发用 <code>macOS</code>。</li> <li>运行环境：仅需要 <a href="https://nodejs.org" target="_blank" rel="noopener noreferrer">Node.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，对应的安装参见<a href="/zh/quickstart/prepare.html">文档</a>。</li></ul> <h3 id="初始化项目"><a href="#初始化项目" aria-hidden="true" class="header-anchor">#</a> 初始化项目</h3> <p>通过骨架来<a href="/zh/workflow/development/init.html">初始化</a>：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 使用 `Egg` 的 `simple` 骨架来初始化</span>
$ <span class="token function">mkdir</span> demo <span class="token operator">&amp;&amp;</span> <span class="token function">cd</span> demo
$ <span class="token function">npm</span> init egg --type<span class="token operator">=</span>simple
$ <span class="token function">npm</span> <span class="token function">install</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="目录结构"><a href="#目录结构" aria-hidden="true" class="header-anchor">#</a> 目录结构</h3> <p>框架奉行『约定优于配置』，所以我们首先来看看生成的目录结构，更多可以参见<a href="/zh/guide/directory.html">目录规范</a>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>demo
├── app
│   ├── controller <span class="token comment"># 控制器</span>
│   │   └── home.js
│   └── router.js  <span class="token comment"># 路由映射</span>
├── config <span class="token comment"># 配置文件</span>
│   ├── config.default.js
│   └── plugin.js
├── <span class="token function">test</span> <span class="token comment"># 单元测试</span>
├── README.md
└── package.json
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="controller"><a href="#controller" aria-hidden="true" class="header-anchor">#</a> <code>Controller</code></h3> <p><a href="/zh/guide/controller.html">Controller</a> 负责<strong>解析用户的输入，处理后返回相应的结果</strong>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/controller/home.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Controller <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'hi, egg'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> HomeController<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>接着配置 <a href="/zh/guide/router.html">路由</a> 映射到对应的 <code>URL</code> 上。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
<span class="token comment">/**
 * @param {Egg.Application} app - egg application
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
  router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>home<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="本地开发"><a href="#本地开发" aria-hidden="true" class="header-anchor">#</a> 本地开发</h3> <p>框架提供了<a href="/zh/workflow/development/development.html">本地开发</a>的辅助工具。</p> <ul><li>辅助本地启动应用，监控代码变更自动重启。</li> <li>自动生成 <code>d.ts</code> 文件，提供 <code>智能提示</code> 和 <code>代码跳转</code> 等能力。</li></ul> <p>通过命令启动应用：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">npm</span> run dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后就可以访问 <code>http://127.0.0.1:7001</code>。</p> <h3 id="模板渲染"><a href="#模板渲染" aria-hidden="true" class="header-anchor">#</a> 模板渲染</h3> <p>绝大多数情况，我们都需要读取数据后渲染模板，然后呈现给用户。</p> <p>但 <code>Egg</code> 并不强制你使用某种模板引擎，故我们需要引入对应的『插件』。</p> <div class="tip custom-block"><p class="custom-block-title">术语讲堂</p> <p>插件机制是我们框架的一大特色。它不但可以保证框架核心的足够精简、稳定、高效，还可以促进业务逻辑的复用，生态圈的形成。
详见<a href="/zh/guide/plugin.html">开发指南 - 插件</a>文档。</p></div> <p>在本章中，我们使用 <a href="https://mozilla.github.io/nunjucks/" target="_blank" rel="noopener noreferrer">Nunjucks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 来渲染，先安装对应的插件 <a href="https://github.com/eggjs/egg-view-nunjucks" target="_blank" rel="noopener noreferrer">egg-view-nunjucks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">npm</span> i egg-view-nunjucks --save
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>开启插件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/plugin.js</span>
exports<span class="token punctuation">.</span>nunjucks <span class="token operator">=</span> <span class="token punctuation">{</span>
  enable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token keyword">package</span><span class="token punctuation">:</span> <span class="token string">'egg-view-nunjucks'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>按照约定，在 <code>app/view</code> 目录下添加对应的模板文件：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token comment">&lt;!-- app/view/home.tpl --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
  ...
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>/public/main.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>对应的 <code>Controller</code> 改为：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 渲染模板 `app/view/home.tpl`</span>
    <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home.tpl'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="静态资源"><a href="#静态资源" aria-hidden="true" class="header-anchor">#</a> 静态资源</h3> <p>前端代码的发布，一般有：</p> <ul><li>构建后发布到 <code>CDN</code>。（推荐）</li> <li>直接在应用中托管。</li></ul> <p><code>Egg</code> 内置了 <a href="https://github.com/eggjs/egg-static" target="_blank" rel="noopener noreferrer">egg-static<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 插件，对后者提供了支持。</p> <p>默认会把 <code>app/public</code> 目录映射到 <code>/public</code> 路由上。</p> <p>在本例中，我们使用 <code>Vue</code> 来写对应的前端逻辑，可以直接参见示例代码。</p> <div class="warning custom-block"><p class="custom-block-title">注意事项</p> <ul><li><code>static</code> 插件，线上会默认设置一年的 <code>magAge</code>。</li> <li>框架默认开启了 <a href="/zh/ecosystem/security/csrf.html">CSRF 防护</a>，故 <code>AJAX</code> 请求需要带上对应的 <code>token</code>：</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/public/main.js</span>
axios<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>headers<span class="token punctuation">.</span>common<span class="token punctuation">[</span><span class="token string">'x-csrf-token'</span><span class="token punctuation">]</span> <span class="token operator">=</span> Cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'csrfToken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></div> <h3 id="配置文件"><a href="#配置文件" aria-hidden="true" class="header-anchor">#</a> 配置文件</h3> <p>写业务的时候，不可避免的需要有<a href="/zh/guide/config.html">配置文件</a>。</p> <p>框架提供了强大的配置合并管理功能。</p> <p>如上述的 <code>nunjucks</code> 插件，添加对应的配置：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// config/config.default.js</span>
config<span class="token punctuation">.</span>view <span class="token operator">=</span> <span class="token punctuation">{</span>
  defaultViewEngine<span class="token punctuation">:</span> <span class="token string">'nunjucks'</span><span class="token punctuation">,</span>
  mapping<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'.tpl'</span><span class="token punctuation">:</span> <span class="token string">'nunjucks'</span><span class="token punctuation">,</span>
    <span class="token string">'.html'</span><span class="token punctuation">:</span> <span class="token string">'nunjucks'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="warning custom-block"><p class="custom-block-title">注意事项</p> <p>是 <code>config</code> 目录，不是 <code>app/config</code>!</p></div> <h3 id="service"><a href="#service" aria-hidden="true" class="header-anchor">#</a> <code>Service</code></h3> <p>我们的业务逻辑一般会写在 <a href="/zh/guide/service.html">Service</a> 里，然后供 <code>Controller</code> 调用。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/service/todo.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">TodoService</span> <span class="token keyword">extends</span> <span class="token class-name">Service</span> <span class="token punctuation">{</span>
  <span class="token comment">/**
   * create todo
   * @param {Todo} todo - todo info without `id`, but `title` required
   */</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token parameter">todo</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// validate</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>todo<span class="token punctuation">.</span>title<span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ctx<span class="token punctuation">.</span><span class="token function">throw</span><span class="token punctuation">(</span><span class="token number">422</span><span class="token punctuation">,</span> <span class="token string">'task title required'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// normalize</span>
    todo<span class="token punctuation">.</span>id <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    todo<span class="token punctuation">.</span>completed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>store<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> todo<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>对应的 <code>Controller</code> 如下：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/controller/todo.js</span>
<span class="token keyword">class</span> <span class="token class-name">TodoController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> service <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token comment">// params validate, need `egg-validate` plugin</span>
    <span class="token comment">// ctx.validate({ title: { type: 'string' } });</span>

    ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">201</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> service<span class="token punctuation">.</span>todo<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="restful"><a href="#restful" aria-hidden="true" class="header-anchor">#</a> <code>RESTful</code></h3> <p><code>Egg</code> 对 <code>RESTful</code> 这种常见的场景提供了<a href="/zh/guide/router.html#RESTful-风格的-URL-定义">内建的支持</a>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/router.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>

  <span class="token comment">// RESTful 映射</span>
  router<span class="token punctuation">.</span><span class="token function">resources</span><span class="token punctuation">(</span><span class="token string">'/api/todo'</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>todo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>对应的 <code>Controller</code>：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// app/controller/todo.js</span>
<span class="token keyword">class</span> <span class="token class-name">TodoController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token comment">// `GET /api/todo`</span>
  <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// `POST /api/todo`</span>
  <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// `PUT /api/todo`</span>
  <span class="token keyword">async</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment">// `DELETE /api/todo`</span>
  <span class="token keyword">async</span> <span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="单元测试"><a href="#单元测试" aria-hidden="true" class="header-anchor">#</a> 单元测试</h3> <p>Web 应用中的单元测试非常重要，框架也提供了对应的<a href="/zh/workflow/development/unittest.html">单元测试能力支持</a>。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// test/app/controller/todo.test.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> app<span class="token punctuation">,</span> mock<span class="token punctuation">,</span> assert <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg-mock/bootstrap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'test/app/controller/todo.test.js'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should add todo'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> app<span class="token punctuation">.</span><span class="token function">httpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/api/todo'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">:</span> <span class="token string">'Add one'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token regex">/json/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">'X-Response-Time'</span><span class="token punctuation">,</span> <span class="token regex">/\d+ms/</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>title <span class="token operator">===</span> <span class="token string">'Add one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>body<span class="token punctuation">.</span>completed <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/zh/quickstart/" class="prev router-link-active">
          快速开始
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.317272b7.js" defer></script><script src="/assets/js/2.7bd862e7.js" defer></script><script src="/assets/js/5.10b31697.js" defer></script>
  </body>
</html>
